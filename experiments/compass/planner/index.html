<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Work Planner</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: ui-monospace, 'Berkeley Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
      background: #1a1a1a;
      color: #e7e7e7;
      min-height: 100vh;
      font-size: 13px;
      line-height: 1.5;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: #000;
      border-bottom: 1px solid #404040;
    }

    .header h1 {
      font-size: 1rem;
      font-weight: 400;
      color: #e7e7e7;
      letter-spacing: -0.01em;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    button {
      background: #1a1a1a;
      color: #e7e7e7;
      border: 1px solid #404040;
      padding: 5px 12px;
      border-radius: 2px;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
      transition: all 0.15s;
    }

    button:hover {
      background: #2a2a2a;
      border-color: #505050;
    }

    button.primary {
      background: #a9f9dd;
      color: #000;
      border-color: #a9f9dd;
    }

    button.primary:hover {
      background: #c0ffea;
      border-color: #c0ffea;
    }

    select {
      background: #1a1a1a;
      color: #e7e7e7;
      border: 1px solid #404040;
      padding: 5px 10px;
      border-radius: 2px;
      font-size: 12px;
      font-family: inherit;
    }

    /* Snapshot banner */
    .snapshot-banner {
      background: #000;
      padding: 8px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #404040;
      color: #e7e7e7;
      font-size: 12px;
    }

    .snapshot-banner.hidden {
      display: none;
    }

    /* Grid container */
    .grid-container {
      flex: 1;
      overflow: auto;
      padding: 16px;
      background: #1a1a1a;
    }

    .grid {
      display: grid;
      grid-template-columns: 160px repeat(8, minmax(130px, 1fr));
      gap: 1px;
      background: #404040;
      border: 1px solid #404040;
      border-radius: 2px;
      min-width: fit-content;
    }

    /* Header row */
    .grid-header {
      background: #000;
      padding: 10px 12px;
      font-weight: 400;
      font-size: 11px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #808080;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .grid-header.project-col {
      text-align: left;
    }

    /* Project row */
    .project-name {
      background: #1a1a1a;
      padding: 10px 12px;
      font-weight: 400;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      min-height: 80px;
      color: #e7e7e7;
    }

    .project-name span {
      word-break: break-word;
    }

    .project-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .project-name:hover .project-actions {
      opacity: 1;
    }

    .project-actions button {
      padding: 2px 6px;
      font-size: 11px;
    }

    /* Cells */
    .cell {
      background: #1a1a1a;
      padding: 8px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cell.drag-over {
      background: #252525;
    }

    /* Cards */
    .card {
      background: #000;
      border: 1px solid #404040;
      border-radius: 2px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: grab;
      position: relative;
      transition: border-color 0.15s;
    }

    .card:hover {
      border-color: #606060;
    }

    .card.dragging {
      opacity: 0.5;
    }

    .card-title {
      word-break: break-word;
      color: #e7e7e7;
    }

    .card-scheduled {
      font-size: 11px;
      color: #a9f9dd;
      margin-top: 4px;
    }

    .card-actions {
      position: absolute;
      top: 4px;
      right: 4px;
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .card:hover .card-actions {
      opacity: 1;
    }

    .card-actions button {
      padding: 1px 5px;
      font-size: 10px;
      background: #1a1a1a;
    }

    /* Add project row */
    .add-project-row {
      grid-column: 1 / -1;
      background: #1a1a1a;
      padding: 10px;
    }

    .add-project-row button {
      width: 100%;
      color: #606060;
      border-style: dashed;
    }

    .add-project-row button:hover {
      color: #909090;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: #1a1a1a;
      border: 1px solid #404040;
      border-radius: 2px;
      padding: 20px;
      min-width: 320px;
      max-width: 90%;
    }

    .modal h2 {
      font-size: 13px;
      font-weight: 400;
      margin-bottom: 16px;
      color: #e7e7e7;
    }

    .modal-field {
      margin-bottom: 12px;
    }

    .modal-field label {
      display: block;
      font-size: 11px;
      margin-bottom: 4px;
      color: #808080;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .modal-field input,
    .modal-field select {
      width: 100%;
      padding: 8px;
      background: #000;
      border: 1px solid #404040;
      border-radius: 2px;
      color: #e7e7e7;
      font-size: 13px;
      font-family: inherit;
    }

    .modal-field input:focus,
    .modal-field select:focus {
      outline: none;
      border-color: #a9f9dd;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    /* Read-only mode */
    .read-only .card {
      cursor: default;
    }

    .read-only .card-actions,
    .read-only .project-actions,
    .read-only .add-project-row,
    .read-only .cell-add-btn {
      display: none;
    }

    /* Cell add button */
    .cell-add-btn {
      background: transparent;
      border: 1px dashed #404040;
      color: #606060;
      padding: 4px;
      font-size: 11px;
      margin-top: auto;
    }

    .cell-add-btn:hover {
      background: #252525;
      color: #909090;
      border-color: #505050;
    }

    /* Card metadata */
    .card-meta {
      font-size: 10px;
      color: #606060;
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-created {
      opacity: 0.8;
    }

    .card-history-btn {
      padding: 0;
      background: transparent;
      border: none;
      color: #606060;
      cursor: pointer;
      font-family: inherit;
      font-size: 10px;
    }

    .card-history-btn:hover {
      color: #a9f9dd;
    }

    /* History tooltip */
    .history-tooltip {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: #000;
      border: 1px solid #404040;
      border-radius: 2px;
      padding: 8px;
      margin-bottom: 4px;
      font-size: 10px;
      color: #808080;
      max-height: 150px;
      overflow-y: auto;
      z-index: 20;
      display: none;
    }

    .history-tooltip.visible {
      display: block;
    }

    .history-item {
      padding: 2px 0;
      border-bottom: 1px solid #252525;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-date {
      color: #505050;
    }

    /* Column date range */
    .grid-header-date {
      display: block;
      font-size: 9px;
      font-weight: 400;
      color: #505050;
      margin-top: 2px;
      text-transform: none;
      letter-spacing: 0;
    }

    /* Child count badge */
    .card-children {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
      color: #808080;
      margin-top: 4px;
      cursor: pointer;
    }

    .card-children:hover {
      color: #a9f9dd;
    }

    /* Parent indicator */
    .card-parent {
      font-size: 11px;
      color: #808080;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-parent .unlink-btn {
      padding: 0 4px;
      font-size: 10px;
      background: transparent;
      border: none;
      color: #606060;
      cursor: pointer;
      font-family: inherit;
    }

    .card-parent .unlink-btn:hover {
      color: #e7e7e7;
    }

    /* Card drop target highlight */
    .card.drop-target {
      outline: 1px dashed #a9f9dd;
      outline-offset: 2px;
    }

    /* Relationship highlighting */
    .card.highlight-self {
      background: #1a3a2a;
      border-color: #a9f9dd;
    }

    .card.highlight-parent {
      background: #1a2a20;
      border-color: #70c0a0;
    }

    .card.highlight-grandparent {
      background: #151f1a;
      border-color: #507060;
    }

    .card.highlight-child {
      background: #1a2a20;
      border-color: #70c0a0;
    }

    .card.highlight-grandchild {
      background: #151f1a;
      border-color: #507060;
    }

    /* Touch drag ghost */
    .touch-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      opacity: 0.8;
      transform: translate(-50%, -50%);
    }

    /* Tags */
    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .tag {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 2px;
      font-size: 10px;
      font-weight: 400;
      color: #000;
    }

    .tag-input-wrapper {
      position: relative;
    }

    .tag-input-wrapper input {
      width: 100%;
    }

    .tag-suggestions {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #000;
      border: 1px solid #404040;
      border-top: none;
      border-radius: 0 0 2px 2px;
      max-height: 120px;
      overflow-y: auto;
      z-index: 10;
    }

    .tag-suggestions.visible {
      display: block;
    }

    .tag-suggestion {
      padding: 6px 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .tag-suggestion:hover {
      background: #252525;
    }

    .tag-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .tag-preview .tag {
      cursor: pointer;
    }

    .tag-preview .tag:hover {
      opacity: 0.7;
    }

    /* View toggle buttons */
    .view-toggle {
      display: flex;
      gap: 0;
      border: 1px solid #404040;
      border-radius: 2px;
      overflow: hidden;
    }

    .view-toggle button {
      border: none;
      border-radius: 0;
      border-right: 1px solid #404040;
      padding: 5px 10px;
    }

    .view-toggle button:last-child {
      border-right: none;
    }

    .view-toggle button.active {
      background: #a9f9dd;
      color: #000;
    }

    /* Filter panel */
    .filter-panel {
      background: #000;
      border-bottom: 1px solid #404040;
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s, padding 0.2s;
    }

    .filter-panel.open {
      max-height: 200px;
      padding: 12px 20px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-size: 11px;
      color: #808080;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .filter-group select,
    .filter-group input {
      background: #1a1a1a;
      color: #e7e7e7;
      border: 1px solid #404040;
      padding: 4px 8px;
      border-radius: 2px;
      font-size: 12px;
      font-family: inherit;
    }

    .filter-group input[type="text"] {
      width: 150px;
    }

    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .filter-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 2px;
      font-size: 10px;
      color: #000;
      cursor: pointer;
    }

    .filter-tag.selected {
      outline: 2px solid #e7e7e7;
      outline-offset: 1px;
    }

    .filter-tag .remove {
      font-size: 10px;
      opacity: 0.7;
    }

    .filter-tag .remove:hover {
      opacity: 1;
    }

    .filter-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    .active-filters {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 20px;
      background: #000;
      border-bottom: 1px solid #404040;
      font-size: 11px;
      color: #808080;
    }

    .active-filters.hidden {
      display: none;
    }

    .active-filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #252525;
      border-radius: 2px;
      color: #e7e7e7;
    }

    .active-filter-chip button {
      padding: 0 2px;
      background: transparent;
      border: none;
      color: #808080;
      font-size: 12px;
      cursor: pointer;
    }

    .active-filter-chip button:hover {
      color: #e7e7e7;
    }

    /* Sort controls */
    .sort-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sort-group select {
      min-width: 100px;
    }

    .sort-direction-btn {
      padding: 4px 8px;
      font-size: 12px;
      min-width: 24px;
    }

    /* Table View */
    .table-view {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .table-view th,
    .table-view td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #404040;
    }

    .table-view th {
      background: #000;
      font-weight: 400;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #808080;
      cursor: pointer;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .table-view th:hover {
      color: #e7e7e7;
    }

    .table-view th.sorted {
      color: #a9f9dd;
    }

    .table-view th .sort-indicator {
      margin-left: 4px;
      font-size: 10px;
    }

    .table-view tr {
      background: #1a1a1a;
    }

    .table-view tr:hover {
      background: #252525;
    }

    .table-view td.title-cell {
      max-width: 300px;
    }

    .table-view td.title-cell .title-text {
      display: block;
      word-break: break-word;
    }

    .table-view td.tags-cell .tag {
      margin-right: 4px;
      margin-bottom: 2px;
    }

    .table-view td.actions-cell {
      white-space: nowrap;
    }

    .table-view td.actions-cell button {
      padding: 2px 6px;
      font-size: 10px;
      margin-right: 4px;
    }

    .table-empty {
      padding: 40px 20px;
      text-align: center;
      color: #606060;
    }

    /* Calendar View */
    .calendar-container {
      padding: 16px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .calendar-header h2 {
      font-size: 14px;
      font-weight: 400;
      color: #e7e7e7;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
    }

    .calendar-nav button {
      padding: 4px 12px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #404040;
      border: 1px solid #404040;
      border-radius: 2px;
    }

    .calendar-day-header {
      background: #000;
      padding: 8px;
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #808080;
    }

    .calendar-day {
      background: #1a1a1a;
      min-height: 100px;
      padding: 8px;
      display: flex;
      flex-direction: column;
    }

    .calendar-day.other-month {
      background: #151515;
    }

    .calendar-day.other-month .day-number {
      color: #404040;
    }

    .calendar-day.today {
      background: #1a2520;
    }

    .calendar-day.today .day-number {
      color: #a9f9dd;
    }

    .day-number {
      font-size: 12px;
      color: #808080;
      margin-bottom: 4px;
    }

    .calendar-tasks {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      overflow: hidden;
    }

    .calendar-task {
      font-size: 10px;
      padding: 2px 4px;
      background: #000;
      border: 1px solid #404040;
      border-radius: 2px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .calendar-task:hover {
      border-color: #606060;
    }

    .calendar-more {
      font-size: 10px;
      color: #606060;
      padding: 2px 4px;
    }

    .calendar-add-btn {
      margin-top: auto;
      padding: 2px;
      font-size: 10px;
      background: transparent;
      border: 1px dashed #404040;
      color: #606060;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .calendar-day:hover .calendar-add-btn {
      opacity: 1;
    }

    .calendar-add-btn:hover {
      background: #252525;
      color: #909090;
    }

    .calendar-unscheduled {
      margin-top: 16px;
      padding: 16px;
      background: #000;
      border: 1px solid #404040;
      border-radius: 2px;
    }

    .calendar-unscheduled h3 {
      font-size: 12px;
      font-weight: 400;
      color: #808080;
      margin-bottom: 8px;
    }

    .calendar-unscheduled-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .calendar-unscheduled-task {
      font-size: 11px;
      padding: 4px 8px;
      background: #1a1a1a;
      border: 1px solid #404040;
      border-radius: 2px;
      cursor: pointer;
    }

    .calendar-unscheduled-task:hover {
      border-color: #606060;
    }

    /* Saved Views Dropdown */
    .saved-views-wrapper {
      position: relative;
    }

    .saved-views-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: #1a1a1a;
      border: 1px solid #404040;
      border-radius: 2px;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 50;
      display: none;
    }

    .saved-views-dropdown.visible {
      display: block;
    }

    .saved-view-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #303030;
    }

    .saved-view-item:last-child {
      border-bottom: none;
    }

    .saved-view-item:hover {
      background: #252525;
    }

    .saved-view-item.active {
      background: #1a2a20;
    }

    .saved-view-name {
      font-size: 12px;
      color: #e7e7e7;
    }

    .saved-view-delete {
      padding: 2px 6px;
      font-size: 10px;
      background: transparent;
      border: none;
      color: #606060;
      cursor: pointer;
    }

    .saved-view-delete:hover {
      color: #e7e7e7;
    }

    .saved-views-empty {
      padding: 12px;
      text-align: center;
      color: #606060;
      font-size: 12px;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #404040;
      border-radius: 0;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #505050;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <h1>Work Planner</h1>
      <div class="header-actions">
        <div class="view-toggle">
          <button id="view-board" class="active" title="Board View">Board</button>
          <button id="view-table" title="Table View">Table</button>
          <button id="view-calendar" title="Calendar View">Calendar</button>
        </div>
        <button id="filter-toggle-btn">Filters</button>
        <div class="saved-views-wrapper">
          <button id="views-toggle-btn">Views</button>
          <div id="saved-views-dropdown" class="saved-views-dropdown"></div>
        </div>
        <select id="snapshot-select">
          <option value="">Current</option>
        </select>
        <button id="add-task-btn" class="primary">+ Add Task</button>
      </div>
    </header>

    <div id="filter-panel" class="filter-panel">
      <div class="filter-row">
        <div class="filter-group">
          <label>Search</label>
          <input type="text" id="filter-search" placeholder="Search tasks...">
        </div>
        <div class="filter-group">
          <label>Project</label>
          <select id="filter-project">
            <option value="">All Projects</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Horizon</label>
          <select id="filter-horizon">
            <option value="">All Horizons</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Tags</label>
          <div id="filter-tags-container" class="filter-tags"></div>
        </div>
        <div class="filter-group sort-group">
          <label>Sort</label>
          <select id="sort-field">
            <option value="createdAt">Created Date</option>
            <option value="title">Title</option>
            <option value="scheduledDate">Scheduled Date</option>
            <option value="horizon">Horizon</option>
          </select>
          <button id="sort-direction-btn" class="sort-direction-btn" title="Toggle direction">↓</button>
        </div>
        <div class="filter-actions">
          <button id="clear-filters-btn">Clear</button>
          <button id="save-view-btn">Save View</button>
        </div>
      </div>
    </div>

    <div id="active-filters" class="active-filters hidden">
      <span>Active filters:</span>
      <div id="active-filter-chips"></div>
    </div>

    <div id="snapshot-banner" class="snapshot-banner hidden">
      <span>Viewing snapshot from <strong id="snapshot-date"></strong></span>
      <button id="exit-snapshot-btn">Back to Current</button>
    </div>

    <div class="grid-container">
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <!-- Task Modal -->
  <div id="task-modal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="task-modal-title">Add Task</h2>
      <div class="modal-field">
        <label for="task-title">Title</label>
        <input type="text" id="task-title" placeholder="What needs to be done?">
      </div>
      <div class="modal-field">
        <label for="task-project">Project</label>
        <select id="task-project"></select>
      </div>
      <div class="modal-field">
        <label for="task-horizon">Time Horizon</label>
        <select id="task-horizon">
          <option value="today">Today</option>
          <option value="this-week">This Week</option>
          <option value="this-month">This Month</option>
          <option value="this-quarter">This Quarter</option>
          <option value="this-half">This Half</option>
          <option value="this-year">This Year</option>
          <option value="five-years">5 Years</option>
          <option value="someday">Someday</option>
        </select>
      </div>
      <div class="modal-field">
        <label for="task-scheduled">Scheduled Date (optional)</label>
        <input type="date" id="task-scheduled">
      </div>
      <div class="modal-field">
        <label for="task-tags">Tags (comma-separated)</label>
        <div class="tag-input-wrapper">
          <input type="text" id="task-tags" placeholder="e.g. urgent, frontend, bug">
          <div id="tag-suggestions" class="tag-suggestions"></div>
        </div>
        <div id="tag-preview" class="tag-preview"></div>
      </div>
      <div class="modal-actions">
        <button id="task-cancel-btn">Cancel</button>
        <button id="task-save-btn" class="primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="project-modal-title">Add Project</h2>
      <div class="modal-field">
        <label for="project-name">Project Name</label>
        <input type="text" id="project-name" placeholder="Project name">
      </div>
      <div class="modal-actions">
        <button id="project-cancel-btn">Cancel</button>
        <button id="project-save-btn" class="primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirm-modal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="confirm-title">Confirm</h2>
      <p id="confirm-message"></p>
      <div class="modal-actions">
        <button id="confirm-cancel-btn">Cancel</button>
        <button id="confirm-ok-btn" class="primary">Delete</button>
      </div>
    </div>
  </div>

  <!-- Save View Modal -->
  <div id="save-view-modal" class="modal-overlay hidden">
    <div class="modal">
      <h2>Save View</h2>
      <div class="modal-field">
        <label for="view-name">View Name</label>
        <input type="text" id="view-name" placeholder="My Custom View">
      </div>
      <div class="modal-actions">
        <button id="save-view-cancel-btn">Cancel</button>
        <button id="save-view-save-btn" class="primary">Save</button>
      </div>
    </div>
  </div>

  <script>
    // =========================================
    // Storage Interface (decoupled)
    // =========================================
    const StorageInterface = {
      get: (key) => { throw new Error('Not implemented'); },
      set: (key, value) => { throw new Error('Not implemented'); },
      remove: (key) => { throw new Error('Not implemented'); },
      keys: () => { throw new Error('Not implemented'); }
    };

    // LocalStorage Adapter
    const LocalStorageAdapter = {
      prefix: 'workplanner_',

      get(key) {
        const raw = localStorage.getItem(this.prefix + key);
        if (raw === null) return null;
        try {
          return JSON.parse(raw);
        } catch {
          return null;
        }
      },

      set(key, value) {
        localStorage.setItem(this.prefix + key, JSON.stringify(value));
      },

      remove(key) {
        localStorage.removeItem(this.prefix + key);
      },

      keys() {
        const result = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith(this.prefix)) {
            result.push(key.slice(this.prefix.length));
          }
        }
        return result;
      }
    };

    // Use localStorage adapter
    const storage = LocalStorageAdapter;

    // =========================================
    // Constants
    // =========================================
    const TIME_HORIZONS = [
      { id: 'today', label: 'Today' },
      { id: 'this-week', label: 'This Week' },
      { id: 'this-month', label: 'This Month' },
      { id: 'this-quarter', label: 'This Quarter' },
      { id: 'this-half', label: 'This Half' },
      { id: 'this-year', label: 'This Year' },
      { id: 'five-years', label: '5 Years' },
      { id: 'someday', label: 'Someday' }
    ];

    // =========================================
    // State
    // =========================================
    let state = {
      projects: [],   // { id, name, order }
      tasks: [],      // { id, title, projectId, horizon, scheduledDate, parentId, tags[], createdAt, history[] }
      viewingSnapshot: null,  // null means current, otherwise date string
      currentView: 'board',   // 'board' | 'table' | 'calendar'
      filters: {
        tags: [],
        projects: [],
        horizons: [],
        search: '',
        hasChildren: null,    // null | true | false
        hasParent: null       // null | true | false
      },
      sort: {
        field: 'createdAt',   // 'createdAt' | 'title' | 'scheduledDate' | 'horizon'
        direction: 'desc'
      },
      savedViews: [],
      activeViewId: null,
      filterPanelOpen: false,
      calendarMonth: new Date().getMonth(),
      calendarYear: new Date().getFullYear()
    };

    // =========================================
    // Helpers
    // =========================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    }

    function getTodayString() {
      return new Date().toISOString().split('T')[0];
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + 'T00:00:00');
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatShortDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + 'T00:00:00');
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function formatTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function formatFullTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function getHorizonDateRange(horizonId) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const day = now.getDate();
      const dayOfWeek = now.getDay();

      const formatRange = (d1, d2) => {
        const opts = { month: 'short', day: 'numeric' };
        if (d2) {
          return `${d1.toLocaleDateString(undefined, opts)} – ${d2.toLocaleDateString(undefined, opts)}`;
        }
        return d1.toLocaleDateString(undefined, opts);
      };

      switch (horizonId) {
        case 'today':
          return formatRange(now);

        case 'this-week': {
          const startOfWeek = new Date(year, month, day - dayOfWeek);
          const endOfWeek = new Date(year, month, day - dayOfWeek + 6);
          return formatRange(startOfWeek, endOfWeek);
        }

        case 'this-month': {
          const startOfMonth = new Date(year, month, 1);
          const endOfMonth = new Date(year, month + 1, 0);
          return formatRange(startOfMonth, endOfMonth);
        }

        case 'this-quarter': {
          const quarter = Math.floor(month / 3);
          const startOfQuarter = new Date(year, quarter * 3, 1);
          const endOfQuarter = new Date(year, quarter * 3 + 3, 0);
          return formatRange(startOfQuarter, endOfQuarter);
        }

        case 'this-half': {
          const half = month < 6 ? 0 : 1;
          const startOfHalf = new Date(year, half * 6, 1);
          const endOfHalf = new Date(year, half * 6 + 6, 0);
          return formatRange(startOfHalf, endOfHalf);
        }

        case 'this-year': {
          return `${year}`;
        }

        case 'five-years': {
          return `${year} – ${year + 5}`;
        }

        case 'someday':
          return 'no deadline';

        default:
          return '';
      }
    }

    // =========================================
    // Persistence
    // =========================================
    function loadState() {
      const projects = storage.get('projects');
      const tasks = storage.get('tasks');
      const savedViews = storage.get('savedViews');

      state.projects = projects || [];
      state.tasks = tasks || [];
      state.savedViews = savedViews || [];
    }

    function saveState() {
      storage.set('projects', state.projects);
      storage.set('tasks', state.tasks);
    }

    // =========================================
    // Snapshot System
    // =========================================
    function getSnapshotKey(dateStr) {
      return 'snapshot_' + dateStr;
    }

    function saveSnapshot(dateStr) {
      const snapshot = {
        date: dateStr,
        projects: JSON.parse(JSON.stringify(state.projects)),
        tasks: JSON.parse(JSON.stringify(state.tasks))
      };
      storage.set(getSnapshotKey(dateStr), snapshot);
    }

    function loadSnapshot(dateStr) {
      return storage.get(getSnapshotKey(dateStr));
    }

    function getSnapshotDates() {
      const keys = storage.keys();
      return keys
        .filter(k => k.startsWith('snapshot_'))
        .map(k => k.replace('snapshot_', ''))
        .sort()
        .reverse();
    }

    function checkAndCreateDailySnapshot() {
      const today = getTodayString();
      const lastSnapshotDate = storage.get('lastSnapshotDate');

      if (lastSnapshotDate !== today) {
        // It's a new day - save snapshot of previous state
        if (lastSnapshotDate && (state.projects.length > 0 || state.tasks.length > 0)) {
          saveSnapshot(lastSnapshotDate);
        }
        storage.set('lastSnapshotDate', today);
      }
    }

    // =========================================
    // State Operations
    // =========================================
    function addProject(name) {
      const project = {
        id: generateId(),
        name: name.trim(),
        order: state.projects.length
      };
      state.projects.push(project);
      saveState();
      render();
      return project;
    }

    function updateProject(id, name) {
      const project = state.projects.find(p => p.id === id);
      if (project) {
        project.name = name.trim();
        saveState();
        render();
      }
    }

    function deleteProject(id) {
      state.projects = state.projects.filter(p => p.id !== id);
      state.tasks = state.tasks.filter(t => t.projectId !== id);
      saveState();
      render();
    }

    function addTask(title, projectId, horizon, scheduledDate, parentId, tags) {
      const now = Date.now();
      const task = {
        id: generateId(),
        title: title.trim(),
        projectId,
        horizon,
        scheduledDate: scheduledDate || null,
        parentId: parentId || null,
        tags: tags || [],
        createdAt: now,
        history: [{ type: 'created', timestamp: now, horizon, projectId }]
      };
      state.tasks.push(task);
      saveState();
      render();
      return task;
    }

    function addHistory(task, entry) {
      if (!task.history) task.history = [];
      task.history.push({ ...entry, timestamp: Date.now() });
    }

    function getChildren(taskId) {
      return state.tasks.filter(t => t.parentId === taskId);
    }

    function setParent(childId, parentId) {
      const child = state.tasks.find(t => t.id === childId);
      const parent = state.tasks.find(t => t.id === parentId);
      if (child && childId !== parentId) {
        // Prevent circular references
        let current = parentId;
        while (current) {
          if (current === childId) return; // Would create cycle
          const p = state.tasks.find(t => t.id === current);
          current = p ? p.parentId : null;
        }
        const oldParentId = child.parentId;
        child.parentId = parentId;
        addHistory(child, { type: 'parent-set', parentId, parentTitle: parent?.title, oldParentId });
        saveState();
        render();
      }
    }

    function unlinkFromParent(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (task && task.parentId) {
        const oldParentId = task.parentId;
        const oldParent = state.tasks.find(t => t.id === oldParentId);
        task.parentId = null;
        addHistory(task, { type: 'parent-unlinked', oldParentId, oldParentTitle: oldParent?.title });
        saveState();
        render();
      }
    }

    function updateTask(id, updates) {
      const task = state.tasks.find(t => t.id === id);
      if (task) {
        const changes = {};
        if (updates.title && updates.title !== task.title) changes.title = { from: task.title, to: updates.title };
        if (updates.horizon && updates.horizon !== task.horizon) changes.horizon = { from: task.horizon, to: updates.horizon };
        if (updates.projectId && updates.projectId !== task.projectId) changes.projectId = { from: task.projectId, to: updates.projectId };
        if (updates.scheduledDate !== undefined && updates.scheduledDate !== task.scheduledDate) {
          changes.scheduledDate = { from: task.scheduledDate, to: updates.scheduledDate };
        }
        if (updates.tags !== undefined) {
          const oldTags = task.tags || [];
          const newTags = updates.tags || [];
          if (JSON.stringify(oldTags) !== JSON.stringify(newTags)) {
            changes.tags = { from: oldTags, to: newTags };
          }
        }

        if (Object.keys(changes).length > 0) {
          addHistory(task, { type: 'edited', changes });
        }
        Object.assign(task, updates);
        saveState();
        render();
      }
    }

    function deleteTask(id) {
      // Unlink children before deleting
      state.tasks.forEach(t => {
        if (t.parentId === id) {
          t.parentId = null;
          addHistory(t, { type: 'parent-deleted' });
        }
      });
      state.tasks = state.tasks.filter(t => t.id !== id);
      saveState();
      render();
    }

    function moveTask(taskId, newProjectId, newHorizon) {
      const task = state.tasks.find(t => t.id === taskId);
      if (task) {
        const oldHorizon = task.horizon;
        const oldProjectId = task.projectId;
        if (oldHorizon !== newHorizon || oldProjectId !== newProjectId) {
          addHistory(task, { type: 'moved', fromHorizon: oldHorizon, toHorizon: newHorizon, fromProjectId: oldProjectId, toProjectId: newProjectId });
        }
        task.projectId = newProjectId;
        task.horizon = newHorizon;
        saveState();
        render();
      }
    }

    // =========================================
    // Rendering
    // =========================================
    function render() {
      const grid = document.getElementById('grid');
      const isReadOnly = state.viewingSnapshot !== null;

      if (isReadOnly) {
        grid.classList.add('read-only');
      } else {
        grid.classList.remove('read-only');
      }

      // Update filter UI
      updateFilterUI();

      // Get filtered tasks
      const filteredTasks = getFilteredTasks(state.tasks);

      // Render based on current view
      if (state.currentView === 'board') {
        renderBoardView(grid, filteredTasks, isReadOnly);
      } else if (state.currentView === 'table') {
        renderTableView(grid, filteredTasks, isReadOnly);
      } else if (state.currentView === 'calendar') {
        renderCalendarView(grid, filteredTasks, isReadOnly);
      }

      // Update snapshot selector
      updateSnapshotSelector();
      updateSnapshotBanner();

      // Update view toggle buttons
      document.querySelectorAll('.view-toggle button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`view-${state.currentView}`).classList.add('active');
    }

    function renderBoardView(grid, filteredTasks, isReadOnly) {
      let html = '';

      // Header row
      html += '<div class="grid-header project-col">Project</div>';
      for (const h of TIME_HORIZONS) {
        const dateRange = getHorizonDateRange(h.id);
        html += `<div class="grid-header">${h.label}<span class="grid-header-date">${dateRange}</span></div>`;
      }

      // Project rows
      const projects = state.projects.length > 0 ? state.projects : [];

      for (const project of projects) {
        // Project name cell
        html += `
          <div class="project-name" data-project-id="${project.id}">
            <span>${escapeHtml(project.name)}</span>
            <div class="project-actions">
              <button onclick="showEditProjectModal('${project.id}')">Edit</button>
              <button onclick="confirmDeleteProject('${project.id}')">×</button>
            </div>
          </div>
        `;

        // Task cells for each horizon
        for (const h of TIME_HORIZONS) {
          const tasks = filteredTasks.filter(t => t.projectId === project.id && t.horizon === h.id);
          html += `
            <div class="cell"
                 data-project-id="${project.id}"
                 data-horizon="${h.id}"
                 ondragover="handleDragOver(event)"
                 ondrop="handleDrop(event)"
                 ondragleave="handleDragLeave(event)">
          `;

          for (const task of tasks) {
            html += renderCard(task);
          }

          if (!isReadOnly) {
            html += `<button class="cell-add-btn" onclick="showAddTaskModalForCell('${project.id}', '${h.id}')">+ Add</button>`;
          }

          html += '</div>';
        }
      }

      // Add project row
      if (!isReadOnly) {
        html += `
          <div class="add-project-row">
            <button onclick="showAddProjectModal()">+ Add Project</button>
          </div>
        `;
      }

      grid.innerHTML = html;
    }

    function renderTableView(grid, filteredTasks, isReadOnly) {
      const sortIndicator = (field) => {
        if (state.sort.field !== field) return '';
        return `<span class="sort-indicator">${state.sort.direction === 'asc' ? '↑' : '↓'}</span>`;
      };

      const sortedClass = (field) => state.sort.field === field ? 'sorted' : '';

      if (filteredTasks.length === 0) {
        grid.innerHTML = '<div class="table-empty">No tasks match the current filters</div>';
        return;
      }

      let html = `
        <table class="table-view">
          <thead>
            <tr>
              <th class="${sortedClass('title')}" onclick="setSortField('title')">Title${sortIndicator('title')}</th>
              <th>Project</th>
              <th class="${sortedClass('horizon')}" onclick="setSortField('horizon')">Horizon${sortIndicator('horizon')}</th>
              <th>Tags</th>
              <th class="${sortedClass('scheduledDate')}" onclick="setSortField('scheduledDate')">Scheduled${sortIndicator('scheduledDate')}</th>
              <th class="${sortedClass('createdAt')}" onclick="setSortField('createdAt')">Created${sortIndicator('createdAt')}</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const task of filteredTasks) {
        const project = state.projects.find(p => p.id === task.projectId);
        const horizon = TIME_HORIZONS.find(h => h.id === task.horizon);

        const tagsHtml = task.tags && task.tags.length > 0
          ? task.tags.map(tag =>
              `<span class="tag" style="background: ${getTagColor(tag)}">${escapeHtml(tag)}</span>`
            ).join('')
          : '<span style="color: #606060;">-</span>';

        const scheduledHtml = task.scheduledDate
          ? formatShortDate(task.scheduledDate)
          : '<span style="color: #606060;">-</span>';

        const createdHtml = task.createdAt
          ? formatTimestamp(task.createdAt)
          : '<span style="color: #606060;">-</span>';

        const actionsHtml = isReadOnly ? '' : `
          <button onclick="showEditTaskModal('${task.id}')">Edit</button>
          <button onclick="confirmDeleteTask('${task.id}')">×</button>
        `;

        html += `
          <tr data-task-id="${task.id}">
            <td class="title-cell"><span class="title-text">${escapeHtml(task.title)}</span></td>
            <td>${project ? escapeHtml(project.name) : '<span style="color: #606060;">-</span>'}</td>
            <td>${horizon ? horizon.label : '<span style="color: #606060;">-</span>'}</td>
            <td class="tags-cell">${tagsHtml}</td>
            <td>${scheduledHtml}</td>
            <td>${createdHtml}</td>
            <td class="actions-cell">${actionsHtml}</td>
          </tr>
        `;
      }

      html += `
          </tbody>
        </table>
      `;

      grid.innerHTML = html;
    }

    function renderCalendarView(grid, filteredTasks, isReadOnly) {
      const year = state.calendarYear;
      const month = state.calendarMonth;
      const today = getTodayString();

      // Get first day of month and days in month
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDayOfWeek = firstDay.getDay();

      // Month name for header
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      const monthName = `${monthNames[month]} ${year}`;

      // Build task lookup by date
      const tasksByDate = {};
      const unscheduledTasks = [];
      filteredTasks.forEach(task => {
        if (task.scheduledDate) {
          if (!tasksByDate[task.scheduledDate]) {
            tasksByDate[task.scheduledDate] = [];
          }
          tasksByDate[task.scheduledDate].push(task);
        } else {
          unscheduledTasks.push(task);
        }
      });

      let html = `
        <div class="calendar-container">
          <div class="calendar-header">
            <h2>${monthName}</h2>
            <div class="calendar-nav">
              <button onclick="navigateCalendar(-1)">← Prev</button>
              <button onclick="navigateCalendar(0)">Today</button>
              <button onclick="navigateCalendar(1)">Next →</button>
            </div>
          </div>
          <div class="calendar-grid">
      `;

      // Day headers
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      for (const day of dayNames) {
        html += `<div class="calendar-day-header">${day}</div>`;
      }

      // Previous month days (fill in start of first week)
      const prevMonth = new Date(year, month, 0);
      const prevMonthDays = prevMonth.getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthDays - i;
        const dateStr = formatDateStr(year, month - 1, day);
        html += renderCalendarDay(dateStr, day, true, isReadOnly, tasksByDate[dateStr] || [], today);
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = formatDateStr(year, month, day);
        html += renderCalendarDay(dateStr, day, false, isReadOnly, tasksByDate[dateStr] || [], today);
      }

      // Next month days (fill in end of last week)
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let day = 1; day <= remainingCells; day++) {
        const dateStr = formatDateStr(year, month + 1, day);
        html += renderCalendarDay(dateStr, day, true, isReadOnly, tasksByDate[dateStr] || [], today);
      }

      html += '</div>';

      // Unscheduled tasks section
      if (unscheduledTasks.length > 0) {
        html += `
          <div class="calendar-unscheduled">
            <h3>Unscheduled Tasks (${unscheduledTasks.length})</h3>
            <div class="calendar-unscheduled-list">
        `;
        for (const task of unscheduledTasks.slice(0, 20)) {
          html += `<div class="calendar-unscheduled-task" onclick="showEditTaskModal('${task.id}')">${escapeHtml(task.title)}</div>`;
        }
        if (unscheduledTasks.length > 20) {
          html += `<div class="calendar-unscheduled-task" style="color: #606060;">+${unscheduledTasks.length - 20} more</div>`;
        }
        html += `
            </div>
          </div>
        `;
      }

      html += '</div>';
      grid.innerHTML = html;
    }

    function renderCalendarDay(dateStr, day, isOtherMonth, isReadOnly, tasks, today) {
      const isToday = dateStr === today;
      const classes = ['calendar-day'];
      if (isOtherMonth) classes.push('other-month');
      if (isToday) classes.push('today');

      let tasksHtml = '<div class="calendar-tasks">';
      const maxTasks = 3;
      for (let i = 0; i < Math.min(tasks.length, maxTasks); i++) {
        const task = tasks[i];
        tasksHtml += `<div class="calendar-task" onclick="showEditTaskModal('${task.id}')" title="${escapeHtml(task.title)}">${escapeHtml(task.title)}</div>`;
      }
      if (tasks.length > maxTasks) {
        tasksHtml += `<div class="calendar-more">+${tasks.length - maxTasks} more</div>`;
      }
      tasksHtml += '</div>';

      const addBtn = isReadOnly ? '' :
        `<button class="calendar-add-btn" onclick="addTaskForDate('${dateStr}')">+</button>`;

      return `
        <div class="${classes.join(' ')}" data-date="${dateStr}">
          <div class="day-number">${day}</div>
          ${tasksHtml}
          ${addBtn}
        </div>
      `;
    }

    function formatDateStr(year, month, day) {
      // Handle month overflow/underflow
      const date = new Date(year, month, day);
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function navigateCalendar(direction) {
      if (direction === 0) {
        // Go to today
        const now = new Date();
        state.calendarMonth = now.getMonth();
        state.calendarYear = now.getFullYear();
      } else {
        state.calendarMonth += direction;
        if (state.calendarMonth > 11) {
          state.calendarMonth = 0;
          state.calendarYear++;
        } else if (state.calendarMonth < 0) {
          state.calendarMonth = 11;
          state.calendarYear--;
        }
      }
      render();
    }

    function addTaskForDate(dateStr) {
      if (state.projects.length === 0) {
        alert('Please create a project first');
        showAddProjectModal();
        return;
      }
      showAddTaskModal();
      document.getElementById('task-scheduled').value = dateStr;
    }

    function renderCard(task) {
      const scheduledHtml = task.scheduledDate
        ? `<div class="card-scheduled">${formatDate(task.scheduledDate)}</div>`
        : '';

      const tagsHtml = task.tags && task.tags.length > 0
        ? `<div class="card-tags">${task.tags.map(tag =>
            `<span class="tag" style="background: ${getTagColor(tag)}">${escapeHtml(tag)}</span>`
          ).join('')}</div>`
        : '';

      const children = getChildren(task.id);
      const childrenHtml = children.length > 0
        ? `<div class="card-children"
               onmouseenter="highlightRelationships('${task.id}')"
               onmouseleave="clearHighlights()">
             ↳ ${children.length} child${children.length > 1 ? 'ren' : ''}
           </div>`
        : '';

      const parent = task.parentId ? state.tasks.find(t => t.id === task.parentId) : null;
      const parentHtml = parent
        ? `<div class="card-parent">
             ↑ ${escapeHtml(parent.title.slice(0, 20))}${parent.title.length > 20 ? '...' : ''}
             <button class="unlink-btn" onclick="event.stopPropagation(); unlinkFromParent('${task.id}')" title="Unlink">×</button>
           </div>`
        : '';

      const createdAt = task.createdAt ? formatTimestamp(task.createdAt) : '';
      const historyCount = task.history ? task.history.length : 0;
      const metaHtml = createdAt || historyCount > 1
        ? `<div class="card-meta">
             <span class="card-created">${createdAt ? '+' + createdAt : ''}</span>
             ${historyCount > 1 ? `<button class="card-history-btn" onclick="event.stopPropagation(); toggleHistory('${task.id}')">${historyCount - 1} change${historyCount > 2 ? 's' : ''}</button>` : ''}
           </div>
           <div class="history-tooltip" id="history-${task.id}">${renderHistory(task)}</div>`
        : '';

      return `
        <div class="card"
             draggable="true"
             data-task-id="${task.id}"
             ondragstart="handleDragStart(event)"
             ondragend="handleDragEnd(event)"
             ondragover="handleCardDragOver(event)"
             ondrop="handleCardDrop(event)"
             ondragleave="handleCardDragLeave(event)">
          <div class="card-actions">
            <button onclick="showEditTaskModal('${task.id}')">Edit</button>
            <button onclick="confirmDeleteTask('${task.id}')">×</button>
          </div>
          <div class="card-title">${escapeHtml(task.title)}</div>
          ${tagsHtml}
          ${scheduledHtml}
          ${childrenHtml}
          ${parentHtml}
          ${metaHtml}
        </div>
      `;
    }

    function renderHistory(task) {
      if (!task.history || task.history.length === 0) return '';

      return task.history.slice().reverse().map(entry => {
        const date = formatFullTimestamp(entry.timestamp);
        let description = '';

        switch (entry.type) {
          case 'created':
            description = 'Created';
            break;
          case 'moved':
            const fromH = TIME_HORIZONS.find(h => h.id === entry.fromHorizon);
            const toH = TIME_HORIZONS.find(h => h.id === entry.toHorizon);
            description = `Moved: ${fromH?.label || '?'} → ${toH?.label || '?'}`;
            break;
          case 'edited':
            const fields = Object.keys(entry.changes || {}).join(', ');
            description = `Edited: ${fields}`;
            break;
          case 'parent-set':
            description = `Linked to: ${entry.parentTitle || 'parent'}`;
            break;
          case 'parent-unlinked':
            description = `Unlinked from: ${entry.oldParentTitle || 'parent'}`;
            break;
          case 'parent-deleted':
            description = 'Parent was deleted';
            break;
          default:
            description = entry.type;
        }

        return `<div class="history-item"><span class="history-date">${date}</span> ${description}</div>`;
      }).join('');
    }

    function toggleHistory(taskId) {
      const el = document.getElementById('history-' + taskId);
      if (el) {
        el.classList.toggle('visible');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Tag color palette (muted, monospace-friendly colors)
    const TAG_COLORS = [
      '#a9f9dd', '#f9d9a9', '#a9d9f9', '#f9a9d9', '#d9f9a9',
      '#f9a9a9', '#a9f9f9', '#d9a9f9', '#c9c9c9', '#f9f9a9'
    ];

    function getTagColor(tag) {
      // Hash the tag string to get a consistent color
      let hash = 0;
      for (let i = 0; i < tag.length; i++) {
        hash = ((hash << 5) - hash) + tag.charCodeAt(i);
        hash = hash & hash;
      }
      return TAG_COLORS[Math.abs(hash) % TAG_COLORS.length];
    }

    function getAllTags() {
      const tagSet = new Set();
      state.tasks.forEach(task => {
        if (task.tags) {
          task.tags.forEach(tag => tagSet.add(tag));
        }
      });
      return Array.from(tagSet).sort();
    }

    function parseTags(tagString) {
      if (!tagString) return [];
      return tagString.split(',')
        .map(t => t.trim().toLowerCase())
        .filter(t => t.length > 0);
    }

    function formatTags(tags) {
      if (!tags || tags.length === 0) return '';
      return tags.join(', ');
    }

    // =========================================
    // Filtering & Sorting
    // =========================================
    function sortTasks(tasks) {
      const { field, direction } = state.sort;
      const horizonOrder = TIME_HORIZONS.map(h => h.id);

      return [...tasks].sort((a, b) => {
        let comparison = 0;

        switch (field) {
          case 'title':
            comparison = (a.title || '').localeCompare(b.title || '');
            break;
          case 'createdAt':
            comparison = (a.createdAt || 0) - (b.createdAt || 0);
            break;
          case 'scheduledDate':
            // Tasks without scheduled date go to end
            if (!a.scheduledDate && !b.scheduledDate) comparison = 0;
            else if (!a.scheduledDate) comparison = 1;
            else if (!b.scheduledDate) comparison = -1;
            else comparison = a.scheduledDate.localeCompare(b.scheduledDate);
            break;
          case 'horizon':
            comparison = horizonOrder.indexOf(a.horizon) - horizonOrder.indexOf(b.horizon);
            break;
          default:
            comparison = 0;
        }

        return direction === 'asc' ? comparison : -comparison;
      });
    }

    function getFilteredTasks(tasks) {
      const { tags, projects, horizons, search, hasChildren, hasParent } = state.filters;

      return tasks.filter(task => {
        // Tag filter
        if (tags.length > 0) {
          const taskTags = task.tags || [];
          if (!tags.some(tag => taskTags.includes(tag))) {
            return false;
          }
        }

        // Project filter
        if (projects.length > 0 && !projects.includes(task.projectId)) {
          return false;
        }

        // Horizon filter
        if (horizons.length > 0 && !horizons.includes(task.horizon)) {
          return false;
        }

        // Search filter
        if (search) {
          const searchLower = search.toLowerCase();
          const titleMatch = task.title.toLowerCase().includes(searchLower);
          const tagMatch = (task.tags || []).some(t => t.toLowerCase().includes(searchLower));
          if (!titleMatch && !tagMatch) {
            return false;
          }
        }

        // Has children filter
        if (hasChildren !== null) {
          const children = getChildren(task.id);
          if (hasChildren && children.length === 0) return false;
          if (!hasChildren && children.length > 0) return false;
        }

        // Has parent filter
        if (hasParent !== null) {
          if (hasParent && !task.parentId) return false;
          if (!hasParent && task.parentId) return false;
        }

        return true;
      });

      // Apply sorting
      return sortTasks(filtered);
    }

    function hasActiveFilters() {
      const { tags, projects, horizons, search, hasChildren, hasParent } = state.filters;
      return tags.length > 0 || projects.length > 0 || horizons.length > 0 ||
             search !== '' || hasChildren !== null || hasParent !== null;
    }

    function clearFilters() {
      state.filters = {
        tags: [],
        projects: [],
        horizons: [],
        search: '',
        hasChildren: null,
        hasParent: null
      };
      updateFilterUI();
      render();
    }

    function toggleFilterTag(tag) {
      const index = state.filters.tags.indexOf(tag);
      if (index === -1) {
        state.filters.tags.push(tag);
      } else {
        state.filters.tags.splice(index, 1);
      }
      updateFilterUI();
      render();
    }

    function setFilterProject(projectId) {
      if (projectId) {
        state.filters.projects = [projectId];
      } else {
        state.filters.projects = [];
      }
      render();
    }

    function setFilterHorizon(horizon) {
      if (horizon) {
        state.filters.horizons = [horizon];
      } else {
        state.filters.horizons = [];
      }
      render();
    }

    function setFilterSearch(search) {
      state.filters.search = search;
      render();
    }

    function updateFilterUI() {
      // Update tag pills
      const container = document.getElementById('filter-tags-container');
      const allTags = getAllTags();

      if (allTags.length === 0) {
        container.innerHTML = '<span style="color: #606060; font-size: 11px;">No tags</span>';
      } else {
        container.innerHTML = allTags.map(tag => {
          const selected = state.filters.tags.includes(tag) ? 'selected' : '';
          return `<span class="filter-tag ${selected}" style="background: ${getTagColor(tag)}" onclick="toggleFilterTag('${escapeHtml(tag)}')">${escapeHtml(tag)}</span>`;
        }).join('');
      }

      // Update project dropdown
      const projectSelect = document.getElementById('filter-project');
      let projectHtml = '<option value="">All Projects</option>';
      state.projects.forEach(p => {
        const selected = state.filters.projects.includes(p.id) ? 'selected' : '';
        projectHtml += `<option value="${p.id}" ${selected}>${escapeHtml(p.name)}</option>`;
      });
      projectSelect.innerHTML = projectHtml;

      // Update horizon dropdown
      const horizonSelect = document.getElementById('filter-horizon');
      let horizonHtml = '<option value="">All Horizons</option>';
      TIME_HORIZONS.forEach(h => {
        const selected = state.filters.horizons.includes(h.id) ? 'selected' : '';
        horizonHtml += `<option value="${h.id}" ${selected}>${h.label}</option>`;
      });
      horizonSelect.innerHTML = horizonHtml;

      // Update search
      document.getElementById('filter-search').value = state.filters.search;

      // Update sort UI
      document.getElementById('sort-field').value = state.sort.field;
      document.getElementById('sort-direction-btn').textContent = state.sort.direction === 'asc' ? '↑' : '↓';

      // Update active filters display
      updateActiveFiltersDisplay();
    }

    function updateActiveFiltersDisplay() {
      const container = document.getElementById('active-filters');
      const chips = document.getElementById('active-filter-chips');

      if (!hasActiveFilters()) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');
      let html = '';

      // Tag chips
      state.filters.tags.forEach(tag => {
        html += `<span class="active-filter-chip">
          <span class="tag" style="background: ${getTagColor(tag)}; padding: 0 4px;">${escapeHtml(tag)}</span>
          <button onclick="toggleFilterTag('${escapeHtml(tag)}')">×</button>
        </span>`;
      });

      // Project chip
      if (state.filters.projects.length > 0) {
        const project = state.projects.find(p => p.id === state.filters.projects[0]);
        if (project) {
          html += `<span class="active-filter-chip">
            Project: ${escapeHtml(project.name)}
            <button onclick="setFilterProject('')">×</button>
          </span>`;
        }
      }

      // Horizon chip
      if (state.filters.horizons.length > 0) {
        const horizon = TIME_HORIZONS.find(h => h.id === state.filters.horizons[0]);
        if (horizon) {
          html += `<span class="active-filter-chip">
            Horizon: ${horizon.label}
            <button onclick="setFilterHorizon('')">×</button>
          </span>`;
        }
      }

      // Search chip
      if (state.filters.search) {
        html += `<span class="active-filter-chip">
          Search: "${escapeHtml(state.filters.search)}"
          <button onclick="setFilterSearch(''); document.getElementById('filter-search').value = '';">×</button>
        </span>`;
      }

      chips.innerHTML = html;
    }

    // =========================================
    // Saved Views
    // =========================================
    function saveView(name) {
      const view = {
        id: generateId(),
        name: name.trim(),
        filters: JSON.parse(JSON.stringify(state.filters)),
        sort: JSON.parse(JSON.stringify(state.sort)),
        viewType: state.currentView,
        createdAt: Date.now()
      };
      state.savedViews.push(view);
      state.activeViewId = view.id;
      saveSavedViews();
      updateSavedViewsDropdown();
    }

    function loadView(viewId) {
      const view = state.savedViews.find(v => v.id === viewId);
      if (!view) return;

      state.filters = JSON.parse(JSON.stringify(view.filters));
      state.sort = JSON.parse(JSON.stringify(view.sort));
      state.currentView = view.viewType;
      state.activeViewId = view.id;

      render();
    }

    function deleteView(viewId) {
      state.savedViews = state.savedViews.filter(v => v.id !== viewId);
      if (state.activeViewId === viewId) {
        state.activeViewId = null;
      }
      saveSavedViews();
      updateSavedViewsDropdown();
    }

    function saveSavedViews() {
      storage.set('savedViews', state.savedViews);
    }

    function loadSavedViews() {
      state.savedViews = storage.get('savedViews') || [];
    }

    function updateSavedViewsDropdown() {
      const dropdown = document.getElementById('saved-views-dropdown');

      if (state.savedViews.length === 0) {
        dropdown.innerHTML = '<div class="saved-views-empty">No saved views</div>';
        return;
      }

      let html = '';
      for (const view of state.savedViews) {
        const activeClass = state.activeViewId === view.id ? 'active' : '';
        html += `
          <div class="saved-view-item ${activeClass}" onclick="loadView('${view.id}')">
            <span class="saved-view-name">${escapeHtml(view.name)}</span>
            <button class="saved-view-delete" onclick="event.stopPropagation(); deleteView('${view.id}')" title="Delete">×</button>
          </div>
        `;
      }
      dropdown.innerHTML = html;
    }

    function showSaveViewModal() {
      document.getElementById('view-name').value = '';
      document.getElementById('save-view-modal').classList.remove('hidden');
      document.getElementById('view-name').focus();
    }

    function hideSaveViewModal() {
      document.getElementById('save-view-modal').classList.add('hidden');
    }

    function confirmSaveView() {
      const name = document.getElementById('view-name').value.trim();
      if (!name) {
        alert('Please enter a view name');
        return;
      }
      saveView(name);
      hideSaveViewModal();
    }

    function toggleSavedViewsDropdown() {
      const dropdown = document.getElementById('saved-views-dropdown');
      dropdown.classList.toggle('visible');
    }

    function updateSnapshotSelector() {
      const select = document.getElementById('snapshot-select');
      const dates = getSnapshotDates();

      let html = '<option value="">Current</option>';
      for (const date of dates) {
        const selected = state.viewingSnapshot === date ? 'selected' : '';
        html += `<option value="${date}" ${selected}>${formatDate(date)}</option>`;
      }
      select.innerHTML = html;
    }

    function updateSnapshotBanner() {
      const banner = document.getElementById('snapshot-banner');
      const dateEl = document.getElementById('snapshot-date');

      if (state.viewingSnapshot) {
        banner.classList.remove('hidden');
        dateEl.textContent = formatDate(state.viewingSnapshot);
      } else {
        banner.classList.add('hidden');
      }
    }

    // =========================================
    // Drag and Drop
    // =========================================
    let draggedTaskId = null;

    function handleDragStart(event) {
      if (state.viewingSnapshot) {
        event.preventDefault();
        return;
      }
      draggedTaskId = event.target.dataset.taskId;
      event.target.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(event) {
      event.target.classList.remove('dragging');
      draggedTaskId = null;
      // Clean up any drop targets
      document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
    }

    function handleDragOver(event) {
      if (state.viewingSnapshot) return;
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (state.viewingSnapshot || !draggedTaskId) return;

      // If dropped directly on cell (not on a card), move the task
      const cell = event.currentTarget;
      const projectId = cell.dataset.projectId;
      const horizon = cell.dataset.horizon;

      moveTask(draggedTaskId, projectId, horizon);
      draggedTaskId = null;
    }

    // Card-to-card drop handlers (for parent-child relationships)
    function handleCardDragOver(event) {
      if (state.viewingSnapshot) return;
      event.preventDefault();
      event.stopPropagation();
      const card = event.currentTarget;
      if (card.dataset.taskId !== draggedTaskId) {
        card.classList.add('drop-target');
      }
    }

    function handleCardDragLeave(event) {
      event.currentTarget.classList.remove('drop-target');
    }

    function handleCardDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.classList.remove('drop-target');

      if (state.viewingSnapshot || !draggedTaskId) return;

      const targetTaskId = event.currentTarget.dataset.taskId;
      if (targetTaskId && targetTaskId !== draggedTaskId) {
        // Make dragged task a child of target task
        setParent(draggedTaskId, targetTaskId);
      }
      draggedTaskId = null;
    }

    // =========================================
    // Relationship Highlighting
    // =========================================
    function highlightRelationships(taskId) {
      clearHighlights();

      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      // Highlight self
      const selfCard = document.querySelector(`[data-task-id="${taskId}"]`);
      if (selfCard) selfCard.classList.add('highlight-self');

      // Highlight ancestors (parents, grandparents, etc.)
      highlightAncestors(task.parentId, 1);

      // Highlight descendants (children, grandchildren, etc.)
      highlightDescendants(taskId, 1);
    }

    function highlightAncestors(parentId, depth) {
      if (!parentId || depth > 3) return;

      const parentCard = document.querySelector(`[data-task-id="${parentId}"]`);
      if (parentCard) {
        parentCard.classList.add(depth === 1 ? 'highlight-parent' : 'highlight-grandparent');
      }

      const parent = state.tasks.find(t => t.id === parentId);
      if (parent && parent.parentId) {
        highlightAncestors(parent.parentId, depth + 1);
      }
    }

    function highlightDescendants(taskId, depth) {
      if (depth > 3) return;

      const children = getChildren(taskId);
      for (const child of children) {
        const childCard = document.querySelector(`[data-task-id="${child.id}"]`);
        if (childCard) {
          childCard.classList.add(depth === 1 ? 'highlight-child' : 'highlight-grandchild');
        }
        highlightDescendants(child.id, depth + 1);
      }
    }

    function clearHighlights() {
      document.querySelectorAll('.highlight-self, .highlight-parent, .highlight-grandparent, .highlight-child, .highlight-grandchild')
        .forEach(el => el.classList.remove('highlight-self', 'highlight-parent', 'highlight-grandparent', 'highlight-child', 'highlight-grandchild'));
    }

    // =========================================
    // Touch Support for Drag and Drop
    // =========================================
    let touchDragData = null;
    let touchGhost = null;

    function setupTouchHandlers() {
      const grid = document.getElementById('grid');

      grid.addEventListener('touchstart', (e) => {
        const card = e.target.closest('.card');
        if (!card || state.viewingSnapshot) return;

        touchDragData = {
          taskId: card.dataset.taskId,
          startX: e.touches[0].clientX,
          startY: e.touches[0].clientY,
          isDragging: false
        };
      }, { passive: true });

      grid.addEventListener('touchmove', (e) => {
        if (!touchDragData) return;

        const touch = e.touches[0];
        const dx = touch.clientX - touchDragData.startX;
        const dy = touch.clientY - touchDragData.startY;

        // Start dragging after threshold
        if (!touchDragData.isDragging && (Math.abs(dx) > 10 || Math.abs(dy) > 10)) {
          touchDragData.isDragging = true;
          createTouchGhost(touchDragData.taskId);
        }

        if (touchDragData.isDragging) {
          e.preventDefault();
          moveTouchGhost(touch.clientX, touch.clientY);
          updateTouchDropTarget(touch.clientX, touch.clientY);
        }
      }, { passive: false });

      grid.addEventListener('touchend', (e) => {
        if (!touchDragData || !touchDragData.isDragging) {
          touchDragData = null;
          return;
        }

        const touch = e.changedTouches[0];
        const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);

        if (dropTarget) {
          const targetCard = dropTarget.closest('.card');
          const targetCell = dropTarget.closest('.cell');

          if (targetCard && targetCard.dataset.taskId !== touchDragData.taskId) {
            // Drop on card = make child
            setParent(touchDragData.taskId, targetCard.dataset.taskId);
          } else if (targetCell) {
            // Drop on cell = move
            moveTask(touchDragData.taskId, targetCell.dataset.projectId, targetCell.dataset.horizon);
          }
        }

        removeTouchGhost();
        clearTouchDropTargets();
        touchDragData = null;
      }, { passive: true });

      grid.addEventListener('touchcancel', () => {
        removeTouchGhost();
        clearTouchDropTargets();
        touchDragData = null;
      }, { passive: true });
    }

    function createTouchGhost(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (!card) return;

      touchGhost = card.cloneNode(true);
      touchGhost.classList.add('touch-ghost');
      touchGhost.style.width = card.offsetWidth + 'px';
      document.body.appendChild(touchGhost);
    }

    function moveTouchGhost(x, y) {
      if (touchGhost) {
        touchGhost.style.left = x + 'px';
        touchGhost.style.top = y + 'px';
      }
    }

    function removeTouchGhost() {
      if (touchGhost) {
        touchGhost.remove();
        touchGhost = null;
      }
    }

    function updateTouchDropTarget(x, y) {
      clearTouchDropTargets();
      const el = document.elementFromPoint(x, y);
      if (!el) return;

      const card = el.closest('.card');
      const cell = el.closest('.cell');

      if (card && card.dataset.taskId !== touchDragData.taskId) {
        card.classList.add('drop-target');
      } else if (cell) {
        cell.classList.add('drag-over');
      }
    }

    function clearTouchDropTargets() {
      document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    // =========================================
    // Modal Handling
    // =========================================
    let editingTaskId = null;
    let editingProjectId = null;

    // Task Modal
    function showAddTaskModal() {
      editingTaskId = null;
      document.getElementById('task-modal-title').textContent = 'Add Task';
      document.getElementById('task-title').value = '';
      document.getElementById('task-horizon').value = 'today';
      document.getElementById('task-scheduled').value = '';
      document.getElementById('task-tags').value = '';
      updateTagPreview();
      populateProjectSelect();
      document.getElementById('task-modal').classList.remove('hidden');
      document.getElementById('task-title').focus();
    }

    function showAddTaskModalForCell(projectId, horizon) {
      editingTaskId = null;
      document.getElementById('task-modal-title').textContent = 'Add Task';
      document.getElementById('task-title').value = '';
      document.getElementById('task-horizon').value = horizon;
      document.getElementById('task-scheduled').value = '';
      document.getElementById('task-tags').value = '';
      updateTagPreview();
      populateProjectSelect(projectId);
      document.getElementById('task-modal').classList.remove('hidden');
      document.getElementById('task-title').focus();
    }

    function showEditTaskModal(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      editingTaskId = taskId;
      document.getElementById('task-modal-title').textContent = 'Edit Task';
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-horizon').value = task.horizon;
      document.getElementById('task-scheduled').value = task.scheduledDate || '';
      document.getElementById('task-tags').value = formatTags(task.tags);
      updateTagPreview();
      populateProjectSelect(task.projectId);
      document.getElementById('task-modal').classList.remove('hidden');
      document.getElementById('task-title').focus();
    }

    function populateProjectSelect(selectedId) {
      const select = document.getElementById('task-project');
      let html = '';
      for (const p of state.projects) {
        const selected = p.id === selectedId ? 'selected' : '';
        html += `<option value="${p.id}" ${selected}>${escapeHtml(p.name)}</option>`;
      }
      select.innerHTML = html;
    }

    function hideTaskModal() {
      document.getElementById('task-modal').classList.add('hidden');
      document.getElementById('tag-suggestions').classList.remove('visible');
      editingTaskId = null;
    }

    function updateTagPreview() {
      const input = document.getElementById('task-tags');
      const preview = document.getElementById('tag-preview');
      const tags = parseTags(input.value);

      if (tags.length === 0) {
        preview.innerHTML = '';
        return;
      }

      preview.innerHTML = tags.map(tag =>
        `<span class="tag" style="background: ${getTagColor(tag)}" onclick="removeTag('${escapeHtml(tag)}')" title="Click to remove">${escapeHtml(tag)}</span>`
      ).join('');
    }

    function removeTag(tagToRemove) {
      const input = document.getElementById('task-tags');
      const tags = parseTags(input.value).filter(t => t !== tagToRemove);
      input.value = formatTags(tags);
      updateTagPreview();
    }

    function showTagSuggestions() {
      const input = document.getElementById('task-tags');
      const suggestions = document.getElementById('tag-suggestions');
      const allTags = getAllTags();
      const currentTags = parseTags(input.value);
      const inputValue = input.value.split(',').pop().trim().toLowerCase();

      // Filter tags that match input and aren't already selected
      const matchingTags = allTags.filter(tag =>
        !currentTags.includes(tag) &&
        (inputValue === '' || tag.includes(inputValue))
      );

      if (matchingTags.length === 0) {
        suggestions.classList.remove('visible');
        return;
      }

      suggestions.innerHTML = matchingTags.slice(0, 8).map(tag =>
        `<div class="tag-suggestion" onclick="selectTagSuggestion('${escapeHtml(tag)}')">${escapeHtml(tag)}</div>`
      ).join('');
      suggestions.classList.add('visible');
    }

    function selectTagSuggestion(tag) {
      const input = document.getElementById('task-tags');
      const parts = input.value.split(',').map(t => t.trim()).filter(t => t);
      parts.pop(); // Remove partial input
      parts.push(tag);
      input.value = parts.join(', ') + ', ';
      updateTagPreview();
      document.getElementById('tag-suggestions').classList.remove('visible');
      input.focus();
    }

    function saveTaskModal() {
      const title = document.getElementById('task-title').value.trim();
      const projectId = document.getElementById('task-project').value;
      const horizon = document.getElementById('task-horizon').value;
      const scheduled = document.getElementById('task-scheduled').value || null;
      const tags = parseTags(document.getElementById('task-tags').value);

      if (!title) {
        alert('Please enter a task title');
        return;
      }

      if (!projectId) {
        alert('Please select or create a project first');
        return;
      }

      if (editingTaskId) {
        updateTask(editingTaskId, { title, projectId, horizon, scheduledDate: scheduled, tags });
      } else {
        addTask(title, projectId, horizon, scheduled, null, tags);
      }

      hideTaskModal();
    }

    // Project Modal
    function showAddProjectModal() {
      editingProjectId = null;
      document.getElementById('project-modal-title').textContent = 'Add Project';
      document.getElementById('project-name').value = '';
      document.getElementById('project-modal').classList.remove('hidden');
      document.getElementById('project-name').focus();
    }

    function showEditProjectModal(projectId) {
      const project = state.projects.find(p => p.id === projectId);
      if (!project) return;

      editingProjectId = projectId;
      document.getElementById('project-modal-title').textContent = 'Edit Project';
      document.getElementById('project-name').value = project.name;
      document.getElementById('project-modal').classList.remove('hidden');
      document.getElementById('project-name').focus();
    }

    function hideProjectModal() {
      document.getElementById('project-modal').classList.add('hidden');
      editingProjectId = null;
    }

    function saveProjectModal() {
      const name = document.getElementById('project-name').value.trim();

      if (!name) {
        alert('Please enter a project name');
        return;
      }

      if (editingProjectId) {
        updateProject(editingProjectId, name);
      } else {
        addProject(name);
      }

      hideProjectModal();
    }

    // Confirm Modal
    let confirmCallback = null;

    function showConfirmModal(title, message, callback) {
      document.getElementById('confirm-title').textContent = title;
      document.getElementById('confirm-message').textContent = message;
      confirmCallback = callback;
      document.getElementById('confirm-modal').classList.remove('hidden');
    }

    function hideConfirmModal() {
      document.getElementById('confirm-modal').classList.add('hidden');
      confirmCallback = null;
    }

    function confirmDeleteTask(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;
      showConfirmModal(
        'Delete Task',
        `Are you sure you want to delete "${task.title}"?`,
        () => deleteTask(taskId)
      );
    }

    function confirmDeleteProject(projectId) {
      const project = state.projects.find(p => p.id === projectId);
      if (!project) return;
      const taskCount = state.tasks.filter(t => t.projectId === projectId).length;
      showConfirmModal(
        'Delete Project',
        `Are you sure you want to delete "${project.name}" and its ${taskCount} task(s)?`,
        () => deleteProject(projectId)
      );
    }

    // =========================================
    // Snapshot Viewing
    // =========================================
    function viewSnapshot(dateStr) {
      if (!dateStr) {
        // Return to current
        state.viewingSnapshot = null;
        loadState();
        render();
        return;
      }

      const snapshot = loadSnapshot(dateStr);
      if (snapshot) {
        state.viewingSnapshot = dateStr;
        state.projects = snapshot.projects;
        state.tasks = snapshot.tasks;
        render();
      }
    }

    function exitSnapshotView() {
      viewSnapshot(null);
    }

    // =========================================
    // Event Listeners
    // =========================================
    function setupEventListeners() {
      // Add task button
      document.getElementById('add-task-btn').addEventListener('click', () => {
        if (state.projects.length === 0) {
          alert('Please create a project first');
          showAddProjectModal();
          return;
        }
        showAddTaskModal();
      });

      // Task modal
      document.getElementById('task-cancel-btn').addEventListener('click', hideTaskModal);
      document.getElementById('task-save-btn').addEventListener('click', saveTaskModal);
      document.getElementById('task-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) hideTaskModal();
      });

      // Project modal
      document.getElementById('project-cancel-btn').addEventListener('click', hideProjectModal);
      document.getElementById('project-save-btn').addEventListener('click', saveProjectModal);
      document.getElementById('project-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) hideProjectModal();
      });

      // Confirm modal
      document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirmModal);
      document.getElementById('confirm-ok-btn').addEventListener('click', () => {
        if (confirmCallback) confirmCallback();
        hideConfirmModal();
      });
      document.getElementById('confirm-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) hideConfirmModal();
      });

      // Snapshot selector
      document.getElementById('snapshot-select').addEventListener('change', (e) => {
        viewSnapshot(e.target.value);
      });

      // Exit snapshot button
      document.getElementById('exit-snapshot-btn').addEventListener('click', exitSnapshotView);

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideTaskModal();
          hideProjectModal();
          hideConfirmModal();
        }
        if (e.key === 'Enter' && !e.target.matches('input, textarea')) {
          if (!document.getElementById('task-modal').classList.contains('hidden')) {
            saveTaskModal();
          } else if (!document.getElementById('project-modal').classList.contains('hidden')) {
            saveProjectModal();
          }
        }
      });

      // Enter key in inputs
      document.getElementById('task-title').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveTaskModal();
      });
      document.getElementById('project-name').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveProjectModal();
      });

      // Tag input handling
      const tagInput = document.getElementById('task-tags');
      tagInput.addEventListener('input', () => {
        updateTagPreview();
        showTagSuggestions();
      });
      tagInput.addEventListener('focus', () => {
        showTagSuggestions();
      });
      tagInput.addEventListener('blur', () => {
        // Delay to allow click on suggestion
        setTimeout(() => {
          document.getElementById('tag-suggestions').classList.remove('visible');
        }, 150);
      });

      // Filter panel toggle
      document.getElementById('filter-toggle-btn').addEventListener('click', () => {
        state.filterPanelOpen = !state.filterPanelOpen;
        const panel = document.getElementById('filter-panel');
        if (state.filterPanelOpen) {
          panel.classList.add('open');
        } else {
          panel.classList.remove('open');
        }
      });

      // Clear filters
      document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);

      // Filter search input
      let searchTimeout;
      document.getElementById('filter-search').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          setFilterSearch(e.target.value);
        }, 200);
      });

      // Filter project select
      document.getElementById('filter-project').addEventListener('change', (e) => {
        setFilterProject(e.target.value);
      });

      // Filter horizon select
      document.getElementById('filter-horizon').addEventListener('change', (e) => {
        setFilterHorizon(e.target.value);
      });

      // View toggle buttons
      document.getElementById('view-board').addEventListener('click', () => setView('board'));
      document.getElementById('view-table').addEventListener('click', () => setView('table'));
      document.getElementById('view-calendar').addEventListener('click', () => setView('calendar'));

      // Sort controls
      document.getElementById('sort-field').addEventListener('change', (e) => {
        state.sort.field = e.target.value;
        render();
      });

      document.getElementById('sort-direction-btn').addEventListener('click', () => {
        state.sort.direction = state.sort.direction === 'asc' ? 'desc' : 'asc';
        updateSortUI();
        render();
      });

      // Saved views
      document.getElementById('views-toggle-btn').addEventListener('click', toggleSavedViewsDropdown);
      document.getElementById('save-view-btn').addEventListener('click', showSaveViewModal);
      document.getElementById('save-view-cancel-btn').addEventListener('click', hideSaveViewModal);
      document.getElementById('save-view-save-btn').addEventListener('click', confirmSaveView);
      document.getElementById('save-view-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) hideSaveViewModal();
      });
      document.getElementById('view-name').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') confirmSaveView();
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('saved-views-dropdown');
        const wrapper = e.target.closest('.saved-views-wrapper');
        if (!wrapper && dropdown.classList.contains('visible')) {
          dropdown.classList.remove('visible');
        }
      });
    }

    function setView(view) {
      state.currentView = view;
      render();
    }

    function updateSortUI() {
      const btn = document.getElementById('sort-direction-btn');
      btn.textContent = state.sort.direction === 'asc' ? '↑' : '↓';
      document.getElementById('sort-field').value = state.sort.field;
    }

    function setSortField(field) {
      if (state.sort.field === field) {
        // Toggle direction if same field
        state.sort.direction = state.sort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        state.sort.field = field;
        state.sort.direction = 'asc';
      }
      render();
    }

    // =========================================
    // Initialization
    // =========================================
    function init() {
      loadState();
      checkAndCreateDailySnapshot();
      setupEventListeners();
      setupTouchHandlers();
      updateSavedViewsDropdown();
      render();
    }

    // Start the app
    init();
  </script>
</body>
</html>
