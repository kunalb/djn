<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Work Planner</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: ui-monospace, 'Berkeley Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
      background: #1a1a1a;
      color: #e7e7e7;
      min-height: 100vh;
      font-size: 13px;
      line-height: 1.5;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: #000;
      border-bottom: 1px solid #404040;
    }

    .header h1 {
      font-size: 1rem;
      font-weight: 400;
      color: #e7e7e7;
      letter-spacing: -0.01em;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    button {
      background: #1a1a1a;
      color: #e7e7e7;
      border: 1px solid #404040;
      padding: 5px 12px;
      border-radius: 2px;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
      transition: all 0.15s;
    }

    button:hover {
      background: #2a2a2a;
      border-color: #505050;
    }

    button.primary {
      background: #a9f9dd;
      color: #000;
      border-color: #a9f9dd;
    }

    button.primary:hover {
      background: #c0ffea;
      border-color: #c0ffea;
    }

    select {
      background: #1a1a1a;
      color: #e7e7e7;
      border: 1px solid #404040;
      padding: 5px 10px;
      border-radius: 2px;
      font-size: 12px;
      font-family: inherit;
    }

    /* Snapshot banner */
    .snapshot-banner {
      background: #000;
      padding: 8px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #404040;
      color: #e7e7e7;
      font-size: 12px;
    }

    .snapshot-banner.hidden {
      display: none;
    }

    /* Grid container */
    .grid-container {
      flex: 1;
      overflow: auto;
      padding: 16px;
      background: #1a1a1a;
    }

    .grid {
      display: grid;
      grid-template-columns: 160px repeat(8, minmax(130px, 1fr));
      gap: 1px;
      background: #404040;
      border: 1px solid #404040;
      border-radius: 2px;
      min-width: fit-content;
    }

    /* Header row */
    .grid-header {
      background: #000;
      padding: 10px 12px;
      font-weight: 400;
      font-size: 11px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #808080;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .grid-header.project-col {
      text-align: left;
    }

    /* Project row */
    .project-name {
      background: #1a1a1a;
      padding: 10px 12px;
      font-weight: 400;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      min-height: 80px;
      color: #e7e7e7;
    }

    .project-name span {
      word-break: break-word;
    }

    .project-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .project-name:hover .project-actions {
      opacity: 1;
    }

    .project-actions button {
      padding: 2px 6px;
      font-size: 11px;
    }

    /* Cells */
    .cell {
      background: #1a1a1a;
      padding: 8px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cell.drag-over {
      background: #252525;
    }

    /* Cards */
    .card {
      background: #000;
      border: 1px solid #404040;
      border-radius: 2px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: grab;
      position: relative;
      transition: border-color 0.15s;
    }

    .card:hover {
      border-color: #606060;
    }

    .card.dragging {
      opacity: 0.5;
    }

    .card-title {
      word-break: break-word;
      color: #e7e7e7;
    }

    .card-scheduled {
      font-size: 11px;
      color: #a9f9dd;
      margin-top: 4px;
    }

    .card-actions {
      position: absolute;
      top: 4px;
      right: 4px;
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .card:hover .card-actions {
      opacity: 1;
    }

    .card-actions button {
      padding: 1px 5px;
      font-size: 10px;
      background: #1a1a1a;
    }

    /* Add project row */
    .add-project-row {
      grid-column: 1 / -1;
      background: #1a1a1a;
      padding: 10px;
    }

    .add-project-row button {
      width: 100%;
      color: #606060;
      border-style: dashed;
    }

    .add-project-row button:hover {
      color: #909090;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: #1a1a1a;
      border: 1px solid #404040;
      border-radius: 2px;
      padding: 20px;
      min-width: 320px;
      max-width: 90%;
    }

    .modal h2 {
      font-size: 13px;
      font-weight: 400;
      margin-bottom: 16px;
      color: #e7e7e7;
    }

    .modal-field {
      margin-bottom: 12px;
    }

    .modal-field label {
      display: block;
      font-size: 11px;
      margin-bottom: 4px;
      color: #808080;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .modal-field input,
    .modal-field select {
      width: 100%;
      padding: 8px;
      background: #000;
      border: 1px solid #404040;
      border-radius: 2px;
      color: #e7e7e7;
      font-size: 13px;
      font-family: inherit;
    }

    .modal-field input:focus,
    .modal-field select:focus {
      outline: none;
      border-color: #a9f9dd;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    /* Read-only mode */
    .read-only .card {
      cursor: default;
    }

    .read-only .card-actions,
    .read-only .project-actions,
    .read-only .add-project-row,
    .read-only .cell-add-btn {
      display: none;
    }

    /* Cell add button */
    .cell-add-btn {
      background: transparent;
      border: 1px dashed #404040;
      color: #606060;
      padding: 4px;
      font-size: 11px;
      margin-top: auto;
    }

    .cell-add-btn:hover {
      background: #252525;
      color: #909090;
      border-color: #505050;
    }

    /* Card metadata */
    .card-meta {
      font-size: 10px;
      color: #606060;
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-created {
      opacity: 0.8;
    }

    .card-history-btn {
      padding: 0;
      background: transparent;
      border: none;
      color: #606060;
      cursor: pointer;
      font-family: inherit;
      font-size: 10px;
    }

    .card-history-btn:hover {
      color: #a9f9dd;
    }

    /* History tooltip */
    .history-tooltip {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: #000;
      border: 1px solid #404040;
      border-radius: 2px;
      padding: 8px;
      margin-bottom: 4px;
      font-size: 10px;
      color: #808080;
      max-height: 150px;
      overflow-y: auto;
      z-index: 20;
      display: none;
    }

    .history-tooltip.visible {
      display: block;
    }

    .history-item {
      padding: 2px 0;
      border-bottom: 1px solid #252525;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-date {
      color: #505050;
    }

    /* Column date range */
    .grid-header-date {
      display: block;
      font-size: 9px;
      font-weight: 400;
      color: #505050;
      margin-top: 2px;
      text-transform: none;
      letter-spacing: 0;
    }

    /* Child count badge */
    .card-children {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
      color: #808080;
      margin-top: 4px;
      cursor: pointer;
    }

    .card-children:hover {
      color: #a9f9dd;
    }

    /* Parent indicator */
    .card-parent {
      font-size: 11px;
      color: #808080;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-parent .unlink-btn {
      padding: 0 4px;
      font-size: 10px;
      background: transparent;
      border: none;
      color: #606060;
      cursor: pointer;
      font-family: inherit;
    }

    .card-parent .unlink-btn:hover {
      color: #e7e7e7;
    }

    /* Card drop target highlight */
    .card.drop-target {
      outline: 1px dashed #a9f9dd;
      outline-offset: 2px;
    }

    /* Relationship highlighting */
    .card.highlight-self {
      background: #1a3a2a;
      border-color: #a9f9dd;
    }

    .card.highlight-parent {
      background: #1a2a20;
      border-color: #70c0a0;
    }

    .card.highlight-grandparent {
      background: #151f1a;
      border-color: #507060;
    }

    .card.highlight-child {
      background: #1a2a20;
      border-color: #70c0a0;
    }

    .card.highlight-grandchild {
      background: #151f1a;
      border-color: #507060;
    }

    /* Touch drag ghost */
    .touch-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      opacity: 0.8;
      transform: translate(-50%, -50%);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #404040;
      border-radius: 0;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #505050;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <h1>Work Planner</h1>
      <div class="header-actions">
        <select id="snapshot-select">
          <option value="">Current</option>
        </select>
        <button id="add-task-btn" class="primary">+ Add Task</button>
      </div>
    </header>

    <div id="snapshot-banner" class="snapshot-banner hidden">
      <span>Viewing snapshot from <strong id="snapshot-date"></strong></span>
      <button id="exit-snapshot-btn">Back to Current</button>
    </div>

    <div class="grid-container">
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <!-- Task Modal -->
  <div id="task-modal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="task-modal-title">Add Task</h2>
      <div class="modal-field">
        <label for="task-title">Title</label>
        <input type="text" id="task-title" placeholder="What needs to be done?">
      </div>
      <div class="modal-field">
        <label for="task-project">Project</label>
        <select id="task-project"></select>
      </div>
      <div class="modal-field">
        <label for="task-horizon">Time Horizon</label>
        <select id="task-horizon">
          <option value="today">Today</option>
          <option value="this-week">This Week</option>
          <option value="this-month">This Month</option>
          <option value="this-quarter">This Quarter</option>
          <option value="this-half">This Half</option>
          <option value="this-year">This Year</option>
          <option value="five-years">5 Years</option>
          <option value="someday">Someday</option>
        </select>
      </div>
      <div class="modal-field">
        <label for="task-scheduled">Scheduled Date (optional)</label>
        <input type="date" id="task-scheduled">
      </div>
      <div class="modal-actions">
        <button id="task-cancel-btn">Cancel</button>
        <button id="task-save-btn" class="primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="project-modal-title">Add Project</h2>
      <div class="modal-field">
        <label for="project-name">Project Name</label>
        <input type="text" id="project-name" placeholder="Project name">
      </div>
      <div class="modal-actions">
        <button id="project-cancel-btn">Cancel</button>
        <button id="project-save-btn" class="primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirm-modal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="confirm-title">Confirm</h2>
      <p id="confirm-message"></p>
      <div class="modal-actions">
        <button id="confirm-cancel-btn">Cancel</button>
        <button id="confirm-ok-btn" class="primary">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // =========================================
    // Storage Interface (decoupled)
    // =========================================
    const StorageInterface = {
      get: (key) => { throw new Error('Not implemented'); },
      set: (key, value) => { throw new Error('Not implemented'); },
      remove: (key) => { throw new Error('Not implemented'); },
      keys: () => { throw new Error('Not implemented'); }
    };

    // LocalStorage Adapter
    const LocalStorageAdapter = {
      prefix: 'workplanner_',

      get(key) {
        const raw = localStorage.getItem(this.prefix + key);
        if (raw === null) return null;
        try {
          return JSON.parse(raw);
        } catch {
          return null;
        }
      },

      set(key, value) {
        localStorage.setItem(this.prefix + key, JSON.stringify(value));
      },

      remove(key) {
        localStorage.removeItem(this.prefix + key);
      },

      keys() {
        const result = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith(this.prefix)) {
            result.push(key.slice(this.prefix.length));
          }
        }
        return result;
      }
    };

    // Use localStorage adapter
    const storage = LocalStorageAdapter;

    // =========================================
    // Constants
    // =========================================
    const TIME_HORIZONS = [
      { id: 'today', label: 'Today' },
      { id: 'this-week', label: 'This Week' },
      { id: 'this-month', label: 'This Month' },
      { id: 'this-quarter', label: 'This Quarter' },
      { id: 'this-half', label: 'This Half' },
      { id: 'this-year', label: 'This Year' },
      { id: 'five-years', label: '5 Years' },
      { id: 'someday', label: 'Someday' }
    ];

    // =========================================
    // State
    // =========================================
    let state = {
      projects: [],   // { id, name, order }
      tasks: [],      // { id, title, projectId, horizon, scheduledDate, parentId, createdAt, history[] }
      viewingSnapshot: null  // null means current, otherwise date string
    };

    // =========================================
    // Helpers
    // =========================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    }

    function getTodayString() {
      return new Date().toISOString().split('T')[0];
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + 'T00:00:00');
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatShortDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + 'T00:00:00');
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function formatTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function formatFullTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function getHorizonDateRange(horizonId) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const day = now.getDate();
      const dayOfWeek = now.getDay();

      const formatRange = (d1, d2) => {
        const opts = { month: 'short', day: 'numeric' };
        if (d2) {
          return `${d1.toLocaleDateString(undefined, opts)} – ${d2.toLocaleDateString(undefined, opts)}`;
        }
        return d1.toLocaleDateString(undefined, opts);
      };

      switch (horizonId) {
        case 'today':
          return formatRange(now);

        case 'this-week': {
          const startOfWeek = new Date(year, month, day - dayOfWeek);
          const endOfWeek = new Date(year, month, day - dayOfWeek + 6);
          return formatRange(startOfWeek, endOfWeek);
        }

        case 'this-month': {
          const startOfMonth = new Date(year, month, 1);
          const endOfMonth = new Date(year, month + 1, 0);
          return formatRange(startOfMonth, endOfMonth);
        }

        case 'this-quarter': {
          const quarter = Math.floor(month / 3);
          const startOfQuarter = new Date(year, quarter * 3, 1);
          const endOfQuarter = new Date(year, quarter * 3 + 3, 0);
          return formatRange(startOfQuarter, endOfQuarter);
        }

        case 'this-half': {
          const half = month < 6 ? 0 : 1;
          const startOfHalf = new Date(year, half * 6, 1);
          const endOfHalf = new Date(year, half * 6 + 6, 0);
          return formatRange(startOfHalf, endOfHalf);
        }

        case 'this-year': {
          return `${year}`;
        }

        case 'five-years': {
          return `${year} – ${year + 5}`;
        }

        case 'someday':
          return 'no deadline';

        default:
          return '';
      }
    }

    // =========================================
    // Persistence
    // =========================================
    function loadState() {
      const projects = storage.get('projects');
      const tasks = storage.get('tasks');

      state.projects = projects || [];
      state.tasks = tasks || [];
    }

    function saveState() {
      storage.set('projects', state.projects);
      storage.set('tasks', state.tasks);
    }

    // =========================================
    // Snapshot System
    // =========================================
    function getSnapshotKey(dateStr) {
      return 'snapshot_' + dateStr;
    }

    function saveSnapshot(dateStr) {
      const snapshot = {
        date: dateStr,
        projects: JSON.parse(JSON.stringify(state.projects)),
        tasks: JSON.parse(JSON.stringify(state.tasks))
      };
      storage.set(getSnapshotKey(dateStr), snapshot);
    }

    function loadSnapshot(dateStr) {
      return storage.get(getSnapshotKey(dateStr));
    }

    function getSnapshotDates() {
      const keys = storage.keys();
      return keys
        .filter(k => k.startsWith('snapshot_'))
        .map(k => k.replace('snapshot_', ''))
        .sort()
        .reverse();
    }

    function checkAndCreateDailySnapshot() {
      const today = getTodayString();
      const lastSnapshotDate = storage.get('lastSnapshotDate');

      if (lastSnapshotDate !== today) {
        // It's a new day - save snapshot of previous state
        if (lastSnapshotDate && (state.projects.length > 0 || state.tasks.length > 0)) {
          saveSnapshot(lastSnapshotDate);
        }
        storage.set('lastSnapshotDate', today);
      }
    }

    // =========================================
    // State Operations
    // =========================================
    function addProject(name) {
      const project = {
        id: generateId(),
        name: name.trim(),
        order: state.projects.length
      };
      state.projects.push(project);
      saveState();
      render();
      return project;
    }

    function updateProject(id, name) {
      const project = state.projects.find(p => p.id === id);
      if (project) {
        project.name = name.trim();
        saveState();
        render();
      }
    }

    function deleteProject(id) {
      state.projects = state.projects.filter(p => p.id !== id);
      state.tasks = state.tasks.filter(t => t.projectId !== id);
      saveState();
      render();
    }

    function addTask(title, projectId, horizon, scheduledDate, parentId) {
      const now = Date.now();
      const task = {
        id: generateId(),
        title: title.trim(),
        projectId,
        horizon,
        scheduledDate: scheduledDate || null,
        parentId: parentId || null,
        createdAt: now,
        history: [{ type: 'created', timestamp: now, horizon, projectId }]
      };
      state.tasks.push(task);
      saveState();
      render();
      return task;
    }

    function addHistory(task, entry) {
      if (!task.history) task.history = [];
      task.history.push({ ...entry, timestamp: Date.now() });
    }

    function getChildren(taskId) {
      return state.tasks.filter(t => t.parentId === taskId);
    }

    function setParent(childId, parentId) {
      const child = state.tasks.find(t => t.id === childId);
      const parent = state.tasks.find(t => t.id === parentId);
      if (child && childId !== parentId) {
        // Prevent circular references
        let current = parentId;
        while (current) {
          if (current === childId) return; // Would create cycle
          const p = state.tasks.find(t => t.id === current);
          current = p ? p.parentId : null;
        }
        const oldParentId = child.parentId;
        child.parentId = parentId;
        addHistory(child, { type: 'parent-set', parentId, parentTitle: parent?.title, oldParentId });
        saveState();
        render();
      }
    }

    function unlinkFromParent(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (task && task.parentId) {
        const oldParentId = task.parentId;
        const oldParent = state.tasks.find(t => t.id === oldParentId);
        task.parentId = null;
        addHistory(task, { type: 'parent-unlinked', oldParentId, oldParentTitle: oldParent?.title });
        saveState();
        render();
      }
    }

    function updateTask(id, updates) {
      const task = state.tasks.find(t => t.id === id);
      if (task) {
        const changes = {};
        if (updates.title && updates.title !== task.title) changes.title = { from: task.title, to: updates.title };
        if (updates.horizon && updates.horizon !== task.horizon) changes.horizon = { from: task.horizon, to: updates.horizon };
        if (updates.projectId && updates.projectId !== task.projectId) changes.projectId = { from: task.projectId, to: updates.projectId };
        if (updates.scheduledDate !== undefined && updates.scheduledDate !== task.scheduledDate) {
          changes.scheduledDate = { from: task.scheduledDate, to: updates.scheduledDate };
        }

        if (Object.keys(changes).length > 0) {
          addHistory(task, { type: 'edited', changes });
        }
        Object.assign(task, updates);
        saveState();
        render();
      }
    }

    function deleteTask(id) {
      // Unlink children before deleting
      state.tasks.forEach(t => {
        if (t.parentId === id) {
          t.parentId = null;
          addHistory(t, { type: 'parent-deleted' });
        }
      });
      state.tasks = state.tasks.filter(t => t.id !== id);
      saveState();
      render();
    }

    function moveTask(taskId, newProjectId, newHorizon) {
      const task = state.tasks.find(t => t.id === taskId);
      if (task) {
        const oldHorizon = task.horizon;
        const oldProjectId = task.projectId;
        if (oldHorizon !== newHorizon || oldProjectId !== newProjectId) {
          addHistory(task, { type: 'moved', fromHorizon: oldHorizon, toHorizon: newHorizon, fromProjectId: oldProjectId, toProjectId: newProjectId });
        }
        task.projectId = newProjectId;
        task.horizon = newHorizon;
        saveState();
        render();
      }
    }

    // =========================================
    // Rendering
    // =========================================
    function render() {
      const grid = document.getElementById('grid');
      const isReadOnly = state.viewingSnapshot !== null;

      if (isReadOnly) {
        grid.classList.add('read-only');
      } else {
        grid.classList.remove('read-only');
      }

      let html = '';

      // Header row
      html += '<div class="grid-header project-col">Project</div>';
      for (const h of TIME_HORIZONS) {
        const dateRange = getHorizonDateRange(h.id);
        html += `<div class="grid-header">${h.label}<span class="grid-header-date">${dateRange}</span></div>`;
      }

      // Project rows
      const projects = state.projects.length > 0 ? state.projects : [];

      for (const project of projects) {
        // Project name cell
        html += `
          <div class="project-name" data-project-id="${project.id}">
            <span>${escapeHtml(project.name)}</span>
            <div class="project-actions">
              <button onclick="showEditProjectModal('${project.id}')">Edit</button>
              <button onclick="confirmDeleteProject('${project.id}')">×</button>
            </div>
          </div>
        `;

        // Task cells for each horizon
        for (const h of TIME_HORIZONS) {
          const tasks = state.tasks.filter(t => t.projectId === project.id && t.horizon === h.id);
          html += `
            <div class="cell"
                 data-project-id="${project.id}"
                 data-horizon="${h.id}"
                 ondragover="handleDragOver(event)"
                 ondrop="handleDrop(event)"
                 ondragleave="handleDragLeave(event)">
          `;

          for (const task of tasks) {
            html += renderCard(task);
          }

          if (!isReadOnly) {
            html += `<button class="cell-add-btn" onclick="showAddTaskModalForCell('${project.id}', '${h.id}')">+ Add</button>`;
          }

          html += '</div>';
        }
      }

      // Add project row
      if (!isReadOnly) {
        html += `
          <div class="add-project-row">
            <button onclick="showAddProjectModal()">+ Add Project</button>
          </div>
        `;
      }

      grid.innerHTML = html;

      // Update snapshot selector
      updateSnapshotSelector();
      updateSnapshotBanner();
    }

    function renderCard(task) {
      const scheduledHtml = task.scheduledDate
        ? `<div class="card-scheduled">${formatDate(task.scheduledDate)}</div>`
        : '';

      const children = getChildren(task.id);
      const childrenHtml = children.length > 0
        ? `<div class="card-children"
               onmouseenter="highlightRelationships('${task.id}')"
               onmouseleave="clearHighlights()">
             ↳ ${children.length} child${children.length > 1 ? 'ren' : ''}
           </div>`
        : '';

      const parent = task.parentId ? state.tasks.find(t => t.id === task.parentId) : null;
      const parentHtml = parent
        ? `<div class="card-parent">
             ↑ ${escapeHtml(parent.title.slice(0, 20))}${parent.title.length > 20 ? '...' : ''}
             <button class="unlink-btn" onclick="event.stopPropagation(); unlinkFromParent('${task.id}')" title="Unlink">×</button>
           </div>`
        : '';

      const createdAt = task.createdAt ? formatTimestamp(task.createdAt) : '';
      const historyCount = task.history ? task.history.length : 0;
      const metaHtml = createdAt || historyCount > 1
        ? `<div class="card-meta">
             <span class="card-created">${createdAt ? '+' + createdAt : ''}</span>
             ${historyCount > 1 ? `<button class="card-history-btn" onclick="event.stopPropagation(); toggleHistory('${task.id}')">${historyCount - 1} change${historyCount > 2 ? 's' : ''}</button>` : ''}
           </div>
           <div class="history-tooltip" id="history-${task.id}">${renderHistory(task)}</div>`
        : '';

      return `
        <div class="card"
             draggable="true"
             data-task-id="${task.id}"
             ondragstart="handleDragStart(event)"
             ondragend="handleDragEnd(event)"
             ondragover="handleCardDragOver(event)"
             ondrop="handleCardDrop(event)"
             ondragleave="handleCardDragLeave(event)">
          <div class="card-actions">
            <button onclick="showEditTaskModal('${task.id}')">Edit</button>
            <button onclick="confirmDeleteTask('${task.id}')">×</button>
          </div>
          <div class="card-title">${escapeHtml(task.title)}</div>
          ${scheduledHtml}
          ${childrenHtml}
          ${parentHtml}
          ${metaHtml}
        </div>
      `;
    }

    function renderHistory(task) {
      if (!task.history || task.history.length === 0) return '';

      return task.history.slice().reverse().map(entry => {
        const date = formatFullTimestamp(entry.timestamp);
        let description = '';

        switch (entry.type) {
          case 'created':
            description = 'Created';
            break;
          case 'moved':
            const fromH = TIME_HORIZONS.find(h => h.id === entry.fromHorizon);
            const toH = TIME_HORIZONS.find(h => h.id === entry.toHorizon);
            description = `Moved: ${fromH?.label || '?'} → ${toH?.label || '?'}`;
            break;
          case 'edited':
            const fields = Object.keys(entry.changes || {}).join(', ');
            description = `Edited: ${fields}`;
            break;
          case 'parent-set':
            description = `Linked to: ${entry.parentTitle || 'parent'}`;
            break;
          case 'parent-unlinked':
            description = `Unlinked from: ${entry.oldParentTitle || 'parent'}`;
            break;
          case 'parent-deleted':
            description = 'Parent was deleted';
            break;
          default:
            description = entry.type;
        }

        return `<div class="history-item"><span class="history-date">${date}</span> ${description}</div>`;
      }).join('');
    }

    function toggleHistory(taskId) {
      const el = document.getElementById('history-' + taskId);
      if (el) {
        el.classList.toggle('visible');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateSnapshotSelector() {
      const select = document.getElementById('snapshot-select');
      const dates = getSnapshotDates();

      let html = '<option value="">Current</option>';
      for (const date of dates) {
        const selected = state.viewingSnapshot === date ? 'selected' : '';
        html += `<option value="${date}" ${selected}>${formatDate(date)}</option>`;
      }
      select.innerHTML = html;
    }

    function updateSnapshotBanner() {
      const banner = document.getElementById('snapshot-banner');
      const dateEl = document.getElementById('snapshot-date');

      if (state.viewingSnapshot) {
        banner.classList.remove('hidden');
        dateEl.textContent = formatDate(state.viewingSnapshot);
      } else {
        banner.classList.add('hidden');
      }
    }

    // =========================================
    // Drag and Drop
    // =========================================
    let draggedTaskId = null;

    function handleDragStart(event) {
      if (state.viewingSnapshot) {
        event.preventDefault();
        return;
      }
      draggedTaskId = event.target.dataset.taskId;
      event.target.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(event) {
      event.target.classList.remove('dragging');
      draggedTaskId = null;
      // Clean up any drop targets
      document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
    }

    function handleDragOver(event) {
      if (state.viewingSnapshot) return;
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (state.viewingSnapshot || !draggedTaskId) return;

      // If dropped directly on cell (not on a card), move the task
      const cell = event.currentTarget;
      const projectId = cell.dataset.projectId;
      const horizon = cell.dataset.horizon;

      moveTask(draggedTaskId, projectId, horizon);
      draggedTaskId = null;
    }

    // Card-to-card drop handlers (for parent-child relationships)
    function handleCardDragOver(event) {
      if (state.viewingSnapshot) return;
      event.preventDefault();
      event.stopPropagation();
      const card = event.currentTarget;
      if (card.dataset.taskId !== draggedTaskId) {
        card.classList.add('drop-target');
      }
    }

    function handleCardDragLeave(event) {
      event.currentTarget.classList.remove('drop-target');
    }

    function handleCardDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.classList.remove('drop-target');

      if (state.viewingSnapshot || !draggedTaskId) return;

      const targetTaskId = event.currentTarget.dataset.taskId;
      if (targetTaskId && targetTaskId !== draggedTaskId) {
        // Make dragged task a child of target task
        setParent(draggedTaskId, targetTaskId);
      }
      draggedTaskId = null;
    }

    // =========================================
    // Relationship Highlighting
    // =========================================
    function highlightRelationships(taskId) {
      clearHighlights();

      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      // Highlight self
      const selfCard = document.querySelector(`[data-task-id="${taskId}"]`);
      if (selfCard) selfCard.classList.add('highlight-self');

      // Highlight ancestors (parents, grandparents, etc.)
      highlightAncestors(task.parentId, 1);

      // Highlight descendants (children, grandchildren, etc.)
      highlightDescendants(taskId, 1);
    }

    function highlightAncestors(parentId, depth) {
      if (!parentId || depth > 3) return;

      const parentCard = document.querySelector(`[data-task-id="${parentId}"]`);
      if (parentCard) {
        parentCard.classList.add(depth === 1 ? 'highlight-parent' : 'highlight-grandparent');
      }

      const parent = state.tasks.find(t => t.id === parentId);
      if (parent && parent.parentId) {
        highlightAncestors(parent.parentId, depth + 1);
      }
    }

    function highlightDescendants(taskId, depth) {
      if (depth > 3) return;

      const children = getChildren(taskId);
      for (const child of children) {
        const childCard = document.querySelector(`[data-task-id="${child.id}"]`);
        if (childCard) {
          childCard.classList.add(depth === 1 ? 'highlight-child' : 'highlight-grandchild');
        }
        highlightDescendants(child.id, depth + 1);
      }
    }

    function clearHighlights() {
      document.querySelectorAll('.highlight-self, .highlight-parent, .highlight-grandparent, .highlight-child, .highlight-grandchild')
        .forEach(el => el.classList.remove('highlight-self', 'highlight-parent', 'highlight-grandparent', 'highlight-child', 'highlight-grandchild'));
    }

    // =========================================
    // Touch Support for Drag and Drop
    // =========================================
    let touchDragData = null;
    let touchGhost = null;

    function setupTouchHandlers() {
      const grid = document.getElementById('grid');

      grid.addEventListener('touchstart', (e) => {
        const card = e.target.closest('.card');
        if (!card || state.viewingSnapshot) return;

        touchDragData = {
          taskId: card.dataset.taskId,
          startX: e.touches[0].clientX,
          startY: e.touches[0].clientY,
          isDragging: false
        };
      }, { passive: true });

      grid.addEventListener('touchmove', (e) => {
        if (!touchDragData) return;

        const touch = e.touches[0];
        const dx = touch.clientX - touchDragData.startX;
        const dy = touch.clientY - touchDragData.startY;

        // Start dragging after threshold
        if (!touchDragData.isDragging && (Math.abs(dx) > 10 || Math.abs(dy) > 10)) {
          touchDragData.isDragging = true;
          createTouchGhost(touchDragData.taskId);
        }

        if (touchDragData.isDragging) {
          e.preventDefault();
          moveTouchGhost(touch.clientX, touch.clientY);
          updateTouchDropTarget(touch.clientX, touch.clientY);
        }
      }, { passive: false });

      grid.addEventListener('touchend', (e) => {
        if (!touchDragData || !touchDragData.isDragging) {
          touchDragData = null;
          return;
        }

        const touch = e.changedTouches[0];
        const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);

        if (dropTarget) {
          const targetCard = dropTarget.closest('.card');
          const targetCell = dropTarget.closest('.cell');

          if (targetCard && targetCard.dataset.taskId !== touchDragData.taskId) {
            // Drop on card = make child
            setParent(touchDragData.taskId, targetCard.dataset.taskId);
          } else if (targetCell) {
            // Drop on cell = move
            moveTask(touchDragData.taskId, targetCell.dataset.projectId, targetCell.dataset.horizon);
          }
        }

        removeTouchGhost();
        clearTouchDropTargets();
        touchDragData = null;
      }, { passive: true });

      grid.addEventListener('touchcancel', () => {
        removeTouchGhost();
        clearTouchDropTargets();
        touchDragData = null;
      }, { passive: true });
    }

    function createTouchGhost(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (!card) return;

      touchGhost = card.cloneNode(true);
      touchGhost.classList.add('touch-ghost');
      touchGhost.style.width = card.offsetWidth + 'px';
      document.body.appendChild(touchGhost);
    }

    function moveTouchGhost(x, y) {
      if (touchGhost) {
        touchGhost.style.left = x + 'px';
        touchGhost.style.top = y + 'px';
      }
    }

    function removeTouchGhost() {
      if (touchGhost) {
        touchGhost.remove();
        touchGhost = null;
      }
    }

    function updateTouchDropTarget(x, y) {
      clearTouchDropTargets();
      const el = document.elementFromPoint(x, y);
      if (!el) return;

      const card = el.closest('.card');
      const cell = el.closest('.cell');

      if (card && card.dataset.taskId !== touchDragData.taskId) {
        card.classList.add('drop-target');
      } else if (cell) {
        cell.classList.add('drag-over');
      }
    }

    function clearTouchDropTargets() {
      document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    // =========================================
    // Modal Handling
    // =========================================
    let editingTaskId = null;
    let editingProjectId = null;

    // Task Modal
    function showAddTaskModal() {
      editingTaskId = null;
      document.getElementById('task-modal-title').textContent = 'Add Task';
      document.getElementById('task-title').value = '';
      document.getElementById('task-horizon').value = 'today';
      document.getElementById('task-scheduled').value = '';
      populateProjectSelect();
      document.getElementById('task-modal').classList.remove('hidden');
      document.getElementById('task-title').focus();
    }

    function showAddTaskModalForCell(projectId, horizon) {
      editingTaskId = null;
      document.getElementById('task-modal-title').textContent = 'Add Task';
      document.getElementById('task-title').value = '';
      document.getElementById('task-horizon').value = horizon;
      document.getElementById('task-scheduled').value = '';
      populateProjectSelect(projectId);
      document.getElementById('task-modal').classList.remove('hidden');
      document.getElementById('task-title').focus();
    }

    function showEditTaskModal(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      editingTaskId = taskId;
      document.getElementById('task-modal-title').textContent = 'Edit Task';
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-horizon').value = task.horizon;
      document.getElementById('task-scheduled').value = task.scheduledDate || '';
      populateProjectSelect(task.projectId);
      document.getElementById('task-modal').classList.remove('hidden');
      document.getElementById('task-title').focus();
    }

    function populateProjectSelect(selectedId) {
      const select = document.getElementById('task-project');
      let html = '';
      for (const p of state.projects) {
        const selected = p.id === selectedId ? 'selected' : '';
        html += `<option value="${p.id}" ${selected}>${escapeHtml(p.name)}</option>`;
      }
      select.innerHTML = html;
    }

    function hideTaskModal() {
      document.getElementById('task-modal').classList.add('hidden');
      editingTaskId = null;
    }

    function saveTaskModal() {
      const title = document.getElementById('task-title').value.trim();
      const projectId = document.getElementById('task-project').value;
      const horizon = document.getElementById('task-horizon').value;
      const scheduled = document.getElementById('task-scheduled').value || null;

      if (!title) {
        alert('Please enter a task title');
        return;
      }

      if (!projectId) {
        alert('Please select or create a project first');
        return;
      }

      if (editingTaskId) {
        updateTask(editingTaskId, { title, projectId, horizon, scheduledDate: scheduled });
      } else {
        addTask(title, projectId, horizon, scheduled);
      }

      hideTaskModal();
    }

    // Project Modal
    function showAddProjectModal() {
      editingProjectId = null;
      document.getElementById('project-modal-title').textContent = 'Add Project';
      document.getElementById('project-name').value = '';
      document.getElementById('project-modal').classList.remove('hidden');
      document.getElementById('project-name').focus();
    }

    function showEditProjectModal(projectId) {
      const project = state.projects.find(p => p.id === projectId);
      if (!project) return;

      editingProjectId = projectId;
      document.getElementById('project-modal-title').textContent = 'Edit Project';
      document.getElementById('project-name').value = project.name;
      document.getElementById('project-modal').classList.remove('hidden');
      document.getElementById('project-name').focus();
    }

    function hideProjectModal() {
      document.getElementById('project-modal').classList.add('hidden');
      editingProjectId = null;
    }

    function saveProjectModal() {
      const name = document.getElementById('project-name').value.trim();

      if (!name) {
        alert('Please enter a project name');
        return;
      }

      if (editingProjectId) {
        updateProject(editingProjectId, name);
      } else {
        addProject(name);
      }

      hideProjectModal();
    }

    // Confirm Modal
    let confirmCallback = null;

    function showConfirmModal(title, message, callback) {
      document.getElementById('confirm-title').textContent = title;
      document.getElementById('confirm-message').textContent = message;
      confirmCallback = callback;
      document.getElementById('confirm-modal').classList.remove('hidden');
    }

    function hideConfirmModal() {
      document.getElementById('confirm-modal').classList.add('hidden');
      confirmCallback = null;
    }

    function confirmDeleteTask(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;
      showConfirmModal(
        'Delete Task',
        `Are you sure you want to delete "${task.title}"?`,
        () => deleteTask(taskId)
      );
    }

    function confirmDeleteProject(projectId) {
      const project = state.projects.find(p => p.id === projectId);
      if (!project) return;
      const taskCount = state.tasks.filter(t => t.projectId === projectId).length;
      showConfirmModal(
        'Delete Project',
        `Are you sure you want to delete "${project.name}" and its ${taskCount} task(s)?`,
        () => deleteProject(projectId)
      );
    }

    // =========================================
    // Snapshot Viewing
    // =========================================
    function viewSnapshot(dateStr) {
      if (!dateStr) {
        // Return to current
        state.viewingSnapshot = null;
        loadState();
        render();
        return;
      }

      const snapshot = loadSnapshot(dateStr);
      if (snapshot) {
        state.viewingSnapshot = dateStr;
        state.projects = snapshot.projects;
        state.tasks = snapshot.tasks;
        render();
      }
    }

    function exitSnapshotView() {
      viewSnapshot(null);
    }

    // =========================================
    // Event Listeners
    // =========================================
    function setupEventListeners() {
      // Add task button
      document.getElementById('add-task-btn').addEventListener('click', () => {
        if (state.projects.length === 0) {
          alert('Please create a project first');
          showAddProjectModal();
          return;
        }
        showAddTaskModal();
      });

      // Task modal
      document.getElementById('task-cancel-btn').addEventListener('click', hideTaskModal);
      document.getElementById('task-save-btn').addEventListener('click', saveTaskModal);
      document.getElementById('task-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) hideTaskModal();
      });

      // Project modal
      document.getElementById('project-cancel-btn').addEventListener('click', hideProjectModal);
      document.getElementById('project-save-btn').addEventListener('click', saveProjectModal);
      document.getElementById('project-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) hideProjectModal();
      });

      // Confirm modal
      document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirmModal);
      document.getElementById('confirm-ok-btn').addEventListener('click', () => {
        if (confirmCallback) confirmCallback();
        hideConfirmModal();
      });
      document.getElementById('confirm-modal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) hideConfirmModal();
      });

      // Snapshot selector
      document.getElementById('snapshot-select').addEventListener('change', (e) => {
        viewSnapshot(e.target.value);
      });

      // Exit snapshot button
      document.getElementById('exit-snapshot-btn').addEventListener('click', exitSnapshotView);

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideTaskModal();
          hideProjectModal();
          hideConfirmModal();
        }
        if (e.key === 'Enter' && !e.target.matches('input, textarea')) {
          if (!document.getElementById('task-modal').classList.contains('hidden')) {
            saveTaskModal();
          } else if (!document.getElementById('project-modal').classList.contains('hidden')) {
            saveProjectModal();
          }
        }
      });

      // Enter key in inputs
      document.getElementById('task-title').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveTaskModal();
      });
      document.getElementById('project-name').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveProjectModal();
      });
    }

    // =========================================
    // Initialization
    // =========================================
    function init() {
      loadState();
      checkAndCreateDailySnapshot();
      setupEventListeners();
      setupTouchHandlers();
      render();
    }

    // Start the app
    init();
  </script>
</body>
</html>
