use clap::Parser;

// Build version string with git hash and timestamp
const VERSION: &str = concat!(
    env!("CARGO_PKG_VERSION"),
    " (",
    env!("BUILD_GIT_HASH"),
    " ",
    env!("BUILD_TIMESTAMP"),
    ")"
);

#[derive(Parser, Debug)]
#[command(name = "x")]
#[command(about = "Fast terminal LLM command generator")]
#[command(version = VERSION)]
#[command(before_help = "Warning: Alpha software. Commands are generated by LLMs and may be incorrect or destructive. Always review before running.")]
#[command(after_help = r#"Examples:
  x list files sorted by size
  x find large files in this directory
  x -y show disk usage          # skip confirmation
  x -p claude write a bash script
  cat data.json | x extract user ids

Interactive prompt:
  When a command is generated, you'll see: [Y/n/e/...]
    y or Enter  Run the command
    n           Cancel
    e           Edit the command manually
    ...         Type anything else to refine with natural language

  Example refinement:
    $ x list files
    ┌ codex (1.2s)
    │ ls
    └ [Y/n/e/...] sort by size, largest first
    ┌ codex (0.8s)
    │ ls -lhS
    └ [Y/n/e/...] y

Built with Claude"#)]
pub struct Cli {
    /// The natural language request for command generation
    #[arg(trailing_var_arg = true, required_unless_present_any = ["init", "context", "config"])]
    pub request: Vec<String>,

    /// Print shell initialization script (add `eval "$(x --init zsh)"` to .zshrc)
    #[arg(long, value_name = "SHELL")]
    pub init: Option<String>,

    /// Open config file in $EDITOR (creates template if missing)
    #[arg(long)]
    pub config: bool,

    /// Skip confirmation and run immediately
    #[arg(short = 'y', long)]
    pub yes: bool,

    /// Only print the generated command, don't run
    #[arg(short = 'n', long)]
    pub dry_run: bool,

    /// LLM provider to use (claude, gemini, openai)
    #[arg(short, long)]
    pub provider: Option<String>,

    /// Model to use (opus, sonnet, gpt-4o, etc.)
    #[arg(short, long)]
    pub model: Option<String>,

    /// Show captured context (for debugging)
    #[arg(long)]
    pub context: bool,

    /// Include tmux terminal content in context
    #[arg(short = 't', long)]
    pub tmux: bool,

    /// Last command exit code (passed from shell wrapper)
    #[arg(long, hide = true)]
    pub last_exit: Option<i32>,

    /// File to write executed command to (for shell history integration)
    #[arg(long, hide = true)]
    pub hist_file: Option<String>,
}

impl Cli {
    pub fn request_string(&self) -> String {
        self.request.join(" ")
    }
}
